<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>MENYRA â€“ Story</title>

  <!-- WICHTIG: viewport-fit=cover fÃ¼r Safe-Area (iOS) -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root{
      --vvh: 100dvh; /* fallback */
      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
    }

    *{ box-sizing:border-box; }
    html, body{
      height:100%;
      margin:0;
      padding:0;
      background:#000;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden; /* wichtig: keine body-bounce */
      color:#fff;
    }

    /* App Shell */
    .storyApp{
      position: fixed;
      inset: 0;
      height: var(--vvh);
      width: 100%;
      background:#000;
    }

    /* Header (fixed) */
    .storyHeader{
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      z-index: 50;

      padding: calc(var(--safeTop) + 10px) 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;

      pointer-events: none;
      background: linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,0));
    }
    .storyHeader > *{ pointer-events:auto; }

    .hLeft{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .iconBtn{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.28);
      display:grid;
      place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      backdrop-filter: blur(10px);
    }
    .iconBtn:active{ transform: scale(0.98); }

    .backIcon{
      width: 18px; height: 18px;
      fill: #fff;
      opacity: .95;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .brandLogo{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      object-fit: contain;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.14);
    }
    .brandText{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .brandName{
      font-weight: 700;
      font-size: 14px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .brandSub{
      font-size: 11px;
      opacity: .75;
      margin-top: 1px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    /* Feed */
    .feed{
      position: absolute;
      inset: 0;
      height: var(--vvh);
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
      scroll-snap-stop: always;

      /* wichtig: verhindert â€žkomische letzte mmâ€œ in vielen FÃ¤llen */
      overscroll-behavior-y: contain;

      scrollbar-width: none;
    }
    .feed::-webkit-scrollbar{ display:none; }

    .reel{
      position: relative;
      height: var(--vvh);
      width: 100%;
      scroll-snap-align: start;
      background:#000;
    }

    .reelVideo{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      background:#000;
    }

    /* Subtile cinematic gradients */
    .reel::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0) 45%),
        linear-gradient(to bottom, rgba(0,0,0,.38), rgba(0,0,0,0) 38%);
      z-index: 2;
    }

    /* Right actions */
    .actions{
      position:absolute;
      right: 12px;
      bottom: calc(var(--safeBottom) + 120px);
      z-index: 10;
      display:flex;
      flex-direction:column;
      gap: 12px;
      align-items:center;
    }

    .actBtn{
      width: 46px;
      height: 46px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      display:grid;
      place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      backdrop-filter: blur(10px);
    }
    .actBtn:active{ transform: scale(0.98); }
    .actIcon{ width: 20px; height: 20px; fill:#fff; opacity:.95; }

    .actCount{
      margin-top: 6px;
      font-size: 11px;
      font-weight: 700;
      opacity: .9;
      text-align:center;
    }

    /* Bottom product card */
    .productCard{
      position:absolute;
      left: 12px;
      right: 12px;
      bottom: calc(var(--safeBottom) + 14px);
      z-index: 10;

      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.34);
      backdrop-filter: blur(14px);
      padding: 12px;

      display:flex;
      gap: 12px;
      align-items:center;
    }

    .productImg{
      width: 54px;
      height: 54px;
      border-radius: 14px;
      object-fit: cover;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.12);
      flex: 0 0 auto;
    }

    .productInfo{
      flex:1;
      min-width:0;
    }
    .productName{
      font-weight: 800;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .productMeta{
      margin-top: 3px;
      font-size: 12px;
      opacity: .78;
      display:flex;
      justify-content:space-between;
      gap: 10px;
    }

    .productCTA{
      flex: 0 0 auto;
      height: 38px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      color:#fff;
      font-weight: 800;
      font-size: 12px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .productCTA:active{ transform: scale(0.985); }

    /* Comments sheet (demo) */
    .sheetOverlay{
      position: fixed;
      inset: 0;
      z-index: 80;
      background: rgba(0,0,0,0.55);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }
    .sheetOverlay.is-open{
      opacity: 1;
      pointer-events: auto;
    }

    .sheet{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 90;

      transform: translateY(105%);
      transition: transform .22s ease;
      background: #0b0f1a;
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      border-top: 1px solid rgba(255,255,255,0.10);

      padding-bottom: calc(var(--safeBottom) + 12px);
      max-height: calc(var(--vvh) * 0.62);
      display:flex;
      flex-direction:column;
    }
    .sheet.is-open{ transform: translateY(0); }

    .sheetHeader{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .sheetTitle{
      font-weight: 900;
      font-size: 13px;
      letter-spacing: .02em;
    }
    .sheetClose{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      display:grid;
      place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .sheetClose svg{ width: 18px; height: 18px; fill:#fff; opacity:.9; }

    .sheetBody{
      padding: 0 14px 12px;
      overflow:auto;
      scrollbar-width:none;
    }
    .sheetBody::-webkit-scrollbar{ display:none; }

    .cmt{
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display:flex;
      gap: 10px;
      align-items:flex-start;
    }
    .avatar{
      width: 34px; height: 34px;
      border-radius: 12px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.12);
      flex:0 0 auto;
    }
    .cmtText{ flex:1; min-width:0; }
    .cmtName{ font-weight: 900; font-size: 12px; }
    .cmtMsg{ margin-top: 2px; font-size: 12px; opacity:.85; line-height:1.35; }

    .sheetInputRow{
      padding: 10px 14px 0;
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .sheetInput{
      flex:1;
      height: 42px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color:#fff;
      padding: 0 12px;
      outline:none;
      font-size: 12px;
    }
    .sheetSend{
      height: 42px;
      padding: 0 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.10);
      color:#fff;
      font-weight: 900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
  </style>
</head>

<body>
  <div class="storyApp">

    <!-- HEADER -->
    <header class="storyHeader">
      <div class="hLeft">
        <button class="iconBtn" id="backBtn" type="button" aria-label="Back">
          <svg class="backIcon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M15.5 19.5L8 12l7.5-7.5 1.8 1.8L11.6 12l5.7 5.7-1.8 1.8z"/>
          </svg>
        </button>

        <div class="brand">
          <img class="brandLogo" src="./images/Prince-coffe-house-logo.jpg" alt="Logo" />
          <div class="brandText">
            <div class="brandName">Prince Coffe House</div>
            <div class="brandSub">Story</div>
          </div>
        </div>
      </div>

      <button class="iconBtn" id="soundBtn" type="button" aria-label="Sound toggle" title="Sound">
        <svg class="backIcon" id="soundIcon" viewBox="0 0 24 24" aria-hidden="true">
          <!-- volume off (default) -->
          <path d="M16.5 12l3.5 3.5-1.4 1.4L15.1 13.4l-3.6 3.6H8.8v-4H6v-2h2.8V7h2.7l3.6 3.6 3.5-3.5 1.4 1.4L16.5 12z"/>
        </svg>
      </button>
    </header>

    <!-- FEED -->
    <main class="feed" id="feed" aria-label="Story feed">
      <!-- Reel 1 -->
      <section class="reel" data-index="0">
        <video class="reelVideo" src="./images/tik1.mp4" playsinline webkit-playsinline muted preload="metadata" loop></video>

        <div class="actions">
          <div>
            <button class="actBtn likeBtn" type="button" aria-label="Like">
              <svg class="actIcon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 21s-7-4.7-9.4-8.7C.7 8.7 2.6 5.5 6 5.2c1.7-.2 3.2.6 4 1.7.8-1.1 2.3-1.9 4-1.7 3.4.3 5.3 3.5 3.4 7.1C19 16.3 12 21 12 21z"/>
              </svg>
            </button>
            <div class="actCount likeCount">128</div>
          </div>

          <div>
            <button class="actBtn commentBtn" type="button" aria-label="Comments">
              <svg class="actIcon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 4h16v11H7l-3 3V4z"/>
              </svg>
            </button>
            <div class="actCount">24</div>
          </div>
        </div>

        <div class="productCard">
          <img class="productImg" src="./images/Prince-coffe-house-offer.jpg" alt="Product" />
          <div class="productInfo">
            <div class="productName">Burger + Fries</div>
            <div class="productMeta">
              <span>Oferta e ditÃ«s</span>
              <strong>5.90 â‚¬</strong>
            </div>
          </div>
          <button class="productCTA" type="button">Shiko</button>
        </div>
      </section>

      <!-- Reel 2 -->
      <section class="reel" data-index="1">
        <video class="reelVideo" src="./images/tik2.mp4" playsinline webkit-playsinline muted preload="metadata" loop></video>

        <div class="actions">
          <div>
            <button class="actBtn likeBtn" type="button" aria-label="Like">
              <svg class="actIcon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 21s-7-4.7-9.4-8.7C.7 8.7 2.6 5.5 6 5.2c1.7-.2 3.2.6 4 1.7.8-1.1 2.3-1.9 4-1.7 3.4.3 5.3 3.5 3.4 7.1C19 16.3 12 21 12 21z"/>
              </svg>
            </button>
            <div class="actCount likeCount">92</div>
          </div>

          <div>
            <button class="actBtn commentBtn" type="button" aria-label="Comments">
              <svg class="actIcon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 4h16v11H7l-3 3V4z"/>
              </svg>
            </button>
            <div class="actCount">11</div>
          </div>
        </div>

        <div class="productCard">
          <img class="productImg" src="./images/Prince-coffe-house-offer.jpg" alt="Product" />
          <div class="productInfo">
            <div class="productName">Coffee Special</div>
            <div class="productMeta">
              <span>Fresh & hot</span>
              <strong>2.90 â‚¬</strong>
            </div>
          </div>
          <button class="productCTA" type="button">Shiko</button>
        </div>
      </section>

      <!-- Reel 3 -->
      <section class="reel" data-index="2">
        <video class="reelVideo" src="./images/tik3.mp4" playsinline webkit-playsinline muted preload="metadata" loop></video>

        <div class="actions">
          <div>
            <button class="actBtn likeBtn" type="button" aria-label="Like">
              <svg class="actIcon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 21s-7-4.7-9.4-8.7C.7 8.7 2.6 5.5 6 5.2c1.7-.2 3.2.6 4 1.7.8-1.1 2.3-1.9 4-1.7 3.4.3 5.3 3.5 3.4 7.1C19 16.3 12 21 12 21z"/>
              </svg>
            </button>
            <div class="actCount likeCount">301</div>
          </div>

          <div>
            <button class="actBtn commentBtn" type="button" aria-label="Comments">
              <svg class="actIcon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 4h16v11H7l-3 3V4z"/>
              </svg>
            </button>
            <div class="actCount">36</div>
          </div>
        </div>

        <div class="productCard">
          <img class="productImg" src="./images/Prince-coffe-house-offer.jpg" alt="Product" />
          <div class="productInfo">
            <div class="productName">Dessert</div>
            <div class="productMeta">
              <span>Sweet</span>
              <strong>3.50 â‚¬</strong>
            </div>
          </div>
          <button class="productCTA" type="button">Shiko</button>
        </div>
      </section>
    </main>

    <!-- COMMENTS (demo) -->
    <div class="sheetOverlay" id="sheetOverlay" aria-hidden="true"></div>

    <section class="sheet" id="sheet" aria-label="Comments">
      <div class="sheetHeader">
        <div class="sheetTitle">Comments</div>
        <button class="sheetClose" id="sheetClose" type="button" aria-label="Close">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18.3 5.7L12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3 10.6 10.6 16.9 4.3z"/></svg>
        </button>
      </div>

      <div class="sheetBody" id="sheetBody">
        <div class="cmt"><div class="avatar"></div><div class="cmtText"><div class="cmtName">Ardit</div><div class="cmtMsg">Shume mireðŸ”¥</div></div></div>
        <div class="cmt"><div class="avatar"></div><div class="cmtText"><div class="cmtName">Elena</div><div class="cmtMsg">A ka delivery?</div></div></div>
        <div class="cmt"><div class="avatar"></div><div class="cmtText"><div class="cmtName">Blerim</div><div class="cmtMsg">Top oferta âœ…</div></div></div>
      </div>

      <div class="sheetInputRow">
        <input class="sheetInput" type="text" placeholder="Write a comment..." />
        <button class="sheetSend" type="button">Send</button>
      </div>
    </section>

  </div>

  <script type="module">
    // =========================================================
    // STORY FEED â€” TikTok snap + autoplay + safe-area (fast)
    // =========================================================

    const feed = document.getElementById("feed");
    const reels = Array.from(document.querySelectorAll(".reel"));
    const videos = reels.map(r => r.querySelector("video"));
    const backBtn = document.getElementById("backBtn");

    const soundBtn = document.getElementById("soundBtn");
    const soundIcon = document.getElementById("soundIcon");

    const sheet = document.getElementById("sheet");
    const sheetOverlay = document.getElementById("sheetOverlay");
    const sheetClose = document.getElementById("sheetClose");

    let currentIndex = 0;
    let muted = true;
    let snapTimer = null;

    // Use visible viewport height (fix: browser UI overlay on iOS/Android)
    function updateVvh(){
      const vv = window.visualViewport;
      const h = vv ? vv.height : window.innerHeight;
      document.documentElement.style.setProperty("--vvh", Math.round(h) + "px");
    }
    updateVvh();
    window.addEventListener("resize", updateVvh, { passive:true });
    if (window.visualViewport){
      visualViewport.addEventListener("resize", updateVvh, { passive:true });
      visualViewport.addEventListener("scroll", updateVvh, { passive:true });
    }

    function goToIndex(idx, behavior = "auto"){
      const clamped = Math.max(0, Math.min(reels.length - 1, idx));
      const h = feed.clientHeight || window.innerHeight;
      feed.scrollTo({ top: clamped * h, behavior });
    }

    function setMutedState(isMuted){
      muted = isMuted;
      videos.forEach(v => v.muted = true); // iOS safe default
      const active = videos[currentIndex];
      if (!active) return;

      if (!muted){
        // user interaction already happened (button click) -> allow audio
        active.muted = false;
        active.volume = 1;
        active.play().catch(()=>{});
        // volume on icon
        soundIcon.innerHTML = '<path d="M3 10v4h3l4 4V6L6 10H3zm13.5 2a4.5 4.5 0 01-2.1 3.8l-1-1.7a2.5 2.5 0 000-4.2l1-1.7A4.5 4.5 0 0116.5 12z"/><path d="M14.3 3.7l-1 1.7A7.5 7.5 0 0117.5 12a7.5 7.5 0 01-4.2 6.6l1 1.7A9.5 9.5 0 0019.5 12a9.5 9.5 0 00-5.2-8.3z"/>';
      } else {
        // volume off icon
        soundIcon.innerHTML = '<path d="M16.5 12l3.5 3.5-1.4 1.4L15.1 13.4l-3.6 3.6H8.8v-4H6v-2h2.8V7h2.7l3.6 3.6 3.5-3.5 1.4 1.4L16.5 12z"/>';
      }
    }

    function activate(index){
      currentIndex = index;

      videos.forEach((v, i) => {
        if (i === index) return;
        v.pause();
      });

      const v = videos[index];
      if (!v) return;

      // Always start when entering (demo feel)
      try { v.currentTime = 0; } catch(_){}

      // Autoplay (muted)
      v.muted = true;
      v.play().catch(()=>{});

      // If user turned sound ON, unmute active
      if (!muted){
        v.muted = false;
        v.volume = 1;
        v.play().catch(()=>{});
      }
    }

    // IntersectionObserver to detect active reel
    const io = new IntersectionObserver((entries) => {
      // find most visible
      let best = null;
      for (const e of entries){
        if (!best || e.intersectionRatio > best.intersectionRatio) best = e;
      }
      if (!best || !best.isIntersecting) return;

      const idx = parseInt(best.target.dataset.index || "0", 10) || 0;
      if (idx !== currentIndex) activate(idx);
    }, { root: feed, threshold: [0.55, 0.75] });

    reels.forEach(r => io.observe(r));

    // Perfect snap fix: force-align after scroll end (removes "last mm slow")
    feed.addEventListener("scroll", () => {
      if (snapTimer) window.clearTimeout(snapTimer);
      snapTimer = window.setTimeout(() => {
        const h = feed.clientHeight || window.innerHeight;
        const idx = Math.round(feed.scrollTop / h);
        goToIndex(idx, "auto");
      }, 90);
    }, { passive:true });

    // Like + comments (delegation)
    feed.addEventListener("click", (e) => {
      const likeBtn = e.target.closest(".likeBtn");
      if (likeBtn){
        const reel = likeBtn.closest(".reel");
        const countEl = reel?.querySelector(".likeCount");
        const cur = parseInt((countEl?.textContent || "0").trim(), 10) || 0;
        const liked = likeBtn.classList.toggle("is-liked");
        if (countEl) countEl.textContent = String(liked ? (cur + 1) : Math.max(0, cur - 1));
        return;
      }

      const commentBtn = e.target.closest(".commentBtn");
      if (commentBtn){
        openSheet();
        return;
      }
    }, { passive:true });

    function openSheet(){
      sheetOverlay.classList.add("is-open");
      sheet.classList.add("is-open");
      sheetOverlay.setAttribute("aria-hidden","false");
    }
    function closeSheet(){
      sheetOverlay.classList.remove("is-open");
      sheet.classList.remove("is-open");
      sheetOverlay.setAttribute("aria-hidden","true");
    }

    sheetOverlay.addEventListener("click", closeSheet, { passive:true });
    sheetClose.addEventListener("click", closeSheet, { passive:true });

    // Back button: correct return
    backBtn.addEventListener("click", () => {
      // If opened via normal navigation, history.back() is right.
      // If opened directly, fallback to karte-demo.html.
      if (window.history.length > 1) window.history.back();
      else window.location.href = "./karte-demo.html";
    }, { passive:true });

    // Sound toggle
    soundBtn.addEventListener("click", () => {
      setMutedState(!muted);
    }, { passive:true });

    // Start: autoplay first reel
    window.addEventListener("pageshow", () => {
      // ensure alignment + play
      goToIndex(currentIndex, "auto");
      activate(currentIndex);
    }, { passive:true });

    // initial
    activate(0);
    setMutedState(true);
  </script>
</body>
</html>
