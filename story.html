<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>MENYRA – Story</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />

  <!-- PERF: warmup -->
  <link rel="dns-prefetch" href="//vz-14f8b42c-6ba.b-cdn.net" />
  <link rel="preconnect" href="https://vz-14f8b42c-6ba.b-cdn.net" crossorigin />

  <!-- HLS.js (needed for Chrome/Edge/Firefox for .m3u8) -->
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
  <script defer src="https://cdn.jsdelivr.net/npm/hls.js@1.6.15"></script>

  <style>
    :root{
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --txt: #ffffff;
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    html, body{ height:100%; background:#000; }
    body{
      color: var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      overflow: hidden;
      background:#000;
    }

    .reels{
      height: 100vh;
      height: 100svh;
      height: 100dvh;

      overflow-y: auto;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      background:#000;

      scroll-padding-top: var(--safe-top);
      scroll-padding-bottom: var(--safe-bottom);

      touch-action: pan-y;
    }
    .reels::-webkit-scrollbar{ display:none; }
    .reels{ scrollbar-width:none; }

    .reel{
      position: relative;
      height: 100vh;
      height: 100svh;
      height: 100dvh;

      scroll-snap-align: start;
      scroll-snap-stop: always;
      background:#000;
      overflow:hidden;
      isolation:isolate;
    }

    .reel video{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      background:#000;
      transform: translateZ(0);
    }

    .vignette{
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(120% 70% at 50% 10%, rgba(0,0,0,0.12) 0%, rgba(0,0,0,0.55) 70%, rgba(0,0,0,0.8) 100%),
        linear-gradient(to top, rgba(0,0,0,0.55), rgba(0,0,0,0.00) 45%);
      opacity: .9;
      z-index: 5;
    }

    .topbar{
      position:absolute;
      top: 0; left: 0; right: 0;
      padding-top: calc(var(--safe-top) + 10px);
      padding-left: calc(var(--safe-left) + 12px);
      padding-right: calc(var(--safe-right) + 12px);
      padding-bottom: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      z-index: 20;
      pointer-events:none;
    }

    .topbarLeft, .topbarRight{
      display:flex;
      align-items:center;
      gap: 10px;
      pointer-events:auto;
    }

    .btnIcon{
      border:0;
      background: rgba(0,0,0,0.45);
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      backdrop-filter: blur(6px);
    }
    .btnIcon:active{ transform: scale(0.98); }

    .brandPill{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.12);
      pointer-events:auto;
      min-width: 0;
    }
    .brandLogo{
      width: 28px;
      height: 28px;
      border-radius: 10px;
      object-fit: contain;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      flex: 0 0 auto;
    }
    .brandName{
      font-weight: 800;
      font-size: 14px;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 56vw;
    }

    .rail{
      position:absolute;
      right: calc(var(--safe-right) + 12px);
      bottom: calc(var(--safe-bottom) + 110px);
      z-index: 20;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 14px;
      pointer-events:auto;
    }

    .railBtn{
      border:0;
      background: transparent;
      color: #fff;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 6px;
    }
    .railIcon{
      width: 46px;
      height: 46px;
      border-radius: 18px;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.10);
      display:grid;
      place-items:center;
      backdrop-filter: blur(6px);
    }
    .railCount{
      font-size: 12px;
      font-weight: 800;
      color: rgba(255,255,255,0.85);
      white-space: nowrap;
    }

    .railBtn[data-action="like"].is-liked .railIcon{
      background: rgba(255,255,255,0.90);
      color:#111;
    }
    .railBtn[data-action="like"].is-liked svg{ fill:#111; }

    .productTag{
      position:absolute;
      left: calc(var(--safe-left) + 12px);
      right: calc(var(--safe-right) + 12px);
      bottom: calc(var(--safe-bottom) + 16px);
      z-index: 20;
      pointer-events:auto;
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(15,23,42,0.58);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(8px);
    }
    .productImg{
      width: 54px;
      height: 54px;
      border-radius: 14px;
      object-fit: cover;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      flex: 0 0 auto;
    }
    .productMeta{
      min-width:0;
      flex:1;
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .productTitle{
      font-weight: 900;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .productSub{
      font-size: 12px;
      color: rgba(255,255,255,0.72);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .productBtn{
      border:0;
      height: 38px;
      padding: 0 12px;
      border-radius: 14px;
      background: #ffffff;
      color: #0f172a;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      flex: 0 0 auto;
    }
    .productBtn:active{ transform: scale(0.985); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(var(--safe-bottom) + 88px);
      transform: translateX(-50%);
      z-index: 999;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.90);
      font-size: 12px;
      font-weight: 900;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }
  </style>
</head>

<body>
  <div class="toast" id="toast">Sound</div>

  <template id="overlayTpl">
    <header class="topbar">
      <div class="topbarLeft">
        <button class="btnIcon" type="button" data-action="back" aria-label="Back">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M15 18l-6-6 6-6" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="brandPill" aria-label="Restaurant">
          <img class="brandLogo" data-bind="logo" src="" alt="Logo" />
          <div class="brandName" data-bind="name">Restaurant</div>
        </div>
      </div>

      <div class="topbarRight">
        <button class="btnIcon" type="button" data-action="sound" aria-label="Toggle sound">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M11 5L6.5 8.5H3v7h3.5L11 19V5z" stroke="white" stroke-width="2.2" stroke-linejoin="round"/>
            <path d="M15.5 8.5c1.2 1.1 1.2 5.9 0 7" stroke="white" stroke-width="2.2" stroke-linecap="round"/>
            <path d="M18 6.8c2 2.1 2 8.3 0 10.4" stroke="white" stroke-width="2.2" stroke-linecap="round" opacity="0.9"/>
          </svg>
        </button>
      </div>
    </header>

    <aside class="rail">
      <button class="railBtn" type="button" data-action="like" data-count="0">
        <span class="railIcon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="white" aria-hidden="true">
            <path d="M12 21s-7-4.5-9.5-8.9C.7 8.6 3 5.5 6.4 5.5c1.7 0 3.1.8 3.9 2 0 0 .8-2 3.7-2 3.4 0 5.7 3.1 3.9 6.6C19 16.5 12 21 12 21z"/>
          </svg>
        </span>
        <span class="railCount" data-bind="likeCount">0</span>
      </button>

      <button class="railBtn" type="button" data-action="comment" data-count="0">
        <span class="railIcon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="white" aria-hidden="true">
            <path d="M21 12c0 4.4-4 8-9 8-1 0-2-.1-2.9-.4L3 21l1.6-4.1C3.6 15.6 3 13.9 3 12c0-4.4 4-8 9-8s9 3.6 9 8z"/>
          </svg>
        </span>
        <span class="railCount" data-bind="commentCount">0</span>
      </button>

      <button class="railBtn" type="button" data-action="share">
        <span class="railIcon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="white" aria-hidden="true">
            <path d="M14 9l-4 6 4-2 6 3V7l-6 2z"/>
            <path d="M4 20v-9a3 3 0 013-3h5" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </span>
        <span class="railCount">Share</span>
      </button>
    </aside>

    <div class="productTag" role="button" tabindex="0" aria-label="Tagged product">
      <img class="productImg" data-bind="productImg" src="" alt="Product" loading="lazy" decoding="async" />
      <div class="productMeta">
        <div class="productTitle" data-bind="productTitle">Produkt</div>
        <div class="productSub" data-bind="productSub">Tap to view product</div>
      </div>
      <button class="productBtn" type="button" data-action="product">Shiko</button>
    </div>
  </template>

  <main class="reels" id="reels" aria-label="MENYRA Stories"></main>

  <script type="module">
    // =========================================================
    // 1) DATA (deine 10 HLS Links)
    // =========================================================
    const STORIES = [
      { src: "https://vz-14f8b42c-6ba.b-cdn.net/40f49c55-83e0-402a-b342-9afc506209d8/playlist.m3u8" },
      { src: "https://vz-14f8b42c-6ba.b-cdn.net/93212fef-e27a-4bbc-81d8-f98fee1c562f/playlist.m3u8" },
      { src: "https://vz-14f8b42c-6ba.b-cdn.net/624fcfa3-73b2-43fc-9742-ab0c0370ce12/playlist.m3u8" },
      { src: "https://vz-14f8b42c-6ba.b-cdn.net/b08e8ec7-17c8-4504-b473-5e6e6c51adde/playlist.m3u8" },
      { src: "https://vz-14f8b42c-6ba.b-cdn.net/3a333939-6525-4f5a-b5de-f3fe30aac7c4/playlist.m3u8" },
      { src: "https://vz-14f8b42c-6ba.b-cdn.net/38d02e9b-f8fd-446e-82e6-f333a23e4d69/playlist.m3u8" },
      { src: "https://vz-14f8b42c-6ba.b-cdn.net/ddbdc472-79fd-4c3a-9a4d-a8466734b8ef/playlist.m3u8" },
      { src: "https://vz-14f8b42c-6ba.b-cdn.net/fa54daae-3208-48d2-91b2-12f2a7ce72a5/playlist.m3u8" },
      { src: "https://vz-14f8b42c-6ba.b-cdn.net/e3700fff-62e2-4afc-a821-b179a1debb7c/playlist.m3u8" },
      { src: "https://vz-14f8b42c-6ba.b-cdn.net/ada7903b-72ec-422a-9510-6059bf1d75c1/playlist.m3u8" },
    ];

    // Demo-meta (kannst du später dynamisch machen)
    const DEMO_META = {
      name: "Prince Coffe House",
      logo: "./images/Prince-coffe-house-logo.jpg",
      like: ["128","74","203","56","88","145","62","190","39","211"],
      comments: ["16","9","31","5","12","21","8","27","3","44"],
      pTitle: ["Burger + Fries","Classic Burger","Coffee Special","Daily Offer","Burger Menu","Coffee Shot","Fries + Sauce","House Special","Morning Coffee","Burger + Drink"],
      pSub: ["Tap to view product (demo)","Marked product (demo)","Marked product (demo)","Marked product (demo)","Marked product (demo)","Marked product (demo)","Marked product (demo)","Marked product (demo)","Marked product (demo)","Marked product (demo)"],
      pImg: "./images/speise1.avif"
    };

    const reelsEl = document.getElementById("reels");
    const tpl = document.getElementById("overlayTpl");
    const toastEl = document.getElementById("toast");

    function toast(t){
      toastEl.textContent = t;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 700);
    }

    // =========================================================
    // 2) Build DOM (slim HTML)
    // =========================================================
    const reels = [];
    const videos = [];

    STORIES.forEach((s, i) => {
      const sec = document.createElement("section");
      sec.className = "reel";
      sec.dataset.index = String(i);
      sec.dataset.name = DEMO_META.name;
      sec.dataset.logo = DEMO_META.logo;
      sec.dataset.like = DEMO_META.like[i] || "0";
      sec.dataset.comments = DEMO_META.comments[i] || "0";
      sec.dataset.productTitle = DEMO_META.pTitle[i] || "Produkt";
      sec.dataset.productSub = DEMO_META.pSub[i] || "Tap";
      sec.dataset.productImg = DEMO_META.pImg;

      const v = document.createElement("video");
      v.className = "reelVideo";
      v.setAttribute("playsinline", "");
      v.setAttribute("webkit-playsinline", "");
      v.setAttribute("muted", "");     // autoplay safe
      v.setAttribute("autoplay", "");  // helps instant start
      v.setAttribute("loop", "");
      v.setAttribute("preload", "none");
      v.setAttribute("crossorigin", "anonymous");
      v.disablePictureInPicture = true;
      v.dataset.src = s.src; // HLS manifest

      const vig = document.createElement("div");
      vig.className = "vignette";

      // overlay inject
      const frag = tpl.content.cloneNode(true);
      frag.querySelector('[data-bind="logo"]').src = DEMO_META.logo;
      frag.querySelector('[data-bind="name"]').textContent = DEMO_META.name;
      frag.querySelector('[data-bind="likeCount"]').textContent = String(parseInt(sec.dataset.like,10)||0);
      frag.querySelector('[data-bind="commentCount"]').textContent = String(parseInt(sec.dataset.comments,10)||0);
      frag.querySelector('[data-bind="productTitle"]').textContent = sec.dataset.productTitle;
      frag.querySelector('[data-bind="productSub"]').textContent = sec.dataset.productSub;
      frag.querySelector('[data-bind="productImg"]').src = sec.dataset.productImg;

      sec.appendChild(v);
      sec.appendChild(vig);
      sec.appendChild(frag);

      reelsEl.appendChild(sec);
      reels.push(sec);
      videos.push(v);
    });

    // =========================================================
    // 3) HLS Engine (Chrome fast)
    // =========================================================
    const isNativeHls = (() => {
      const t = document.createElement("video");
      return !!(t.canPlayType("application/vnd.apple.mpegurl") || t.canPlayType("application/x-mpegURL"));
    })();

    const hlsMap = new Map(); // index -> Hls instance
    const prepared = new Set(); // index prepared
    let HLS_READY = false;

    function waitForHlsJs(){
      return new Promise((resolve) => {
        if (isNativeHls) return resolve(true);
        const tick = () => {
          if (window.Hls && window.Hls.isSupported && window.Hls.isSupported()){
            HLS_READY = true;
            resolve(true);
            return;
          }
          setTimeout(tick, 20);
        };
        tick();
      });
    }

    function ensurePlayer(i){
      const v = videos[i];
      if (!v) return;

      const src = v.dataset.src;
      if (!src) return;

      if (isNativeHls){
        if (v.src !== src){
          v.src = src;
        }
        prepared.add(i);
        return;
      }

      if (!HLS_READY || !window.Hls || !window.Hls.isSupported()) return;

      if (hlsMap.has(i)) return;

      const Hls = window.Hls;
      const hls = new Hls({
        autoStartLoad: false,            // we decide when to load
        startPosition: 0,
        maxBufferLength: 6,              // keep small -> less RAM, quicker switches
        maxMaxBufferLength: 12,
        backBufferLength: 0,
        enableWorker: true,
        lowLatencyMode: false,
      });

      hls.attachMedia(v);
      hls.loadSource(src);

      // Recovery (no "hängen" forever)
      hls.on(Hls.Events.ERROR, (ev, data) => {
        if (!data || !data.fatal) return;
        try{
          if (data.type === Hls.ErrorTypes.NETWORK_ERROR){
            hls.startLoad();
          } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR){
            hls.recoverMediaError();
          } else {
            hls.destroy();
            hlsMap.delete(i);
            prepared.delete(i);
          }
        }catch(_){}
      });

      hlsMap.set(i, hls);
      prepared.add(i);
    }

    function startLoad(i){
      if (!prepared.has(i)) ensurePlayer(i);
      if (isNativeHls) return;
      const hls = hlsMap.get(i);
      try{ hls?.startLoad(); }catch(_){}
    }

    function stopLoad(i){
      if (isNativeHls) return;
      const hls = hlsMap.get(i);
      try{ hls?.stopLoad(); }catch(_){}
    }

    async function prefetchManifest(url){
      try{
        // warm TLS + cache a tiny bit (best-effort)
        await fetch(url, { mode: "cors", cache: "force-cache" });
      }catch(_){}
    }

    // =========================================================
    // 4) Playback (no random pauses)
    // =========================================================
    const SOUND_KEY = "menyra_story_sound";
    let soundOn = (localStorage.getItem(SOUND_KEY) || "off") === "on";
    let activeIndex = 0;

    function applySound(){
      videos.forEach((v, i) => {
        if (i !== activeIndex){
          v.muted = true;
          v.volume = 0;
          return;
        }
        v.muted = !soundOn;
        v.volume = soundOn ? 1 : 0;
      });
    }

    function safePlay(v){
      if (!v) return;
      const p = v.play();
      if (p && typeof p.catch === "function") p.catch(() => {});
    }

    function activate(i){
      i = Math.max(0, Math.min(videos.length - 1, i));
      if (i === activeIndex) return;

      activeIndex = i;

      // Pause others (CPU), but keep next preloaded via HLS startLoad
      videos.forEach((v, idx) => {
        if (idx !== activeIndex){
          try { v.pause(); } catch(_){}
        }
      });

      warmAround(activeIndex);

      applySound();
      safePlay(videos[activeIndex]);
    }

    function warmAround(idx){
      // Ultra fast: active + next + next2 + prev
      const hot = new Set([idx, idx+1, idx+2, idx-1].filter(x => x >= 0 && x < videos.length));

      // Start loads for hot, stop for far
      for (let i = 0; i < videos.length; i++){
        if (hot.has(i)){
          ensurePlayer(i);
          startLoad(i);
          // warm cache
          const src = videos[i].dataset.src;
          if (src) prefetchManifest(src);
        } else {
          stopLoad(i);
        }
      }

      // Make the "next" start instant: nudge to decode soon
      const next = videos[idx+1];
      if (next){
        // do NOT play; just ensure it can start instantly when activated
        try { next.preload = "auto"; } catch(_){}
      }
    }

    // If active stalls, re-play quickly
    function attachStallFix(){
      videos.forEach((v, i) => {
        v.addEventListener("waiting", () => {
          if (i !== activeIndex) return;
          safePlay(v);
        }, { passive: true });

        v.addEventListener("stalled", () => {
          if (i !== activeIndex) return;
          safePlay(v);
        }, { passive: true });

        v.addEventListener("canplay", () => {
          if (i !== activeIndex) return;
          safePlay(v);
        }, { passive: true });
      });
    }

    // =========================================================
    // 5) Snap Fix (smooth, nicht extrem schnell)
    // =========================================================
    let VIEW_H = 1;
    function updateViewH(){
      VIEW_H = reelsEl.getBoundingClientRect().height || window.innerHeight || 1;
    }
    updateViewH();
    window.addEventListener("resize", updateViewH, { passive:true });

    let snapTimer = null;
    let anim = null;

    function animateTo(top, ms = 240){
      if (anim) cancelAnimationFrame(anim);
      const start = reelsEl.scrollTop;
      const diff = top - start;
      if (Math.abs(diff) < 1) return;

      const t0 = performance.now();
      const dur = Math.max(200, Math.min(ms, 320));

      const ease = (t) => 1 - Math.pow(1 - t, 3);

      const step = (now) => {
        const p = Math.min(1, (now - t0) / dur);
        reelsEl.scrollTop = start + diff * ease(p);
        if (p < 1) anim = requestAnimationFrame(step);
      };
      anim = requestAnimationFrame(step);
    }

    function nearestIndex(){
      return Math.max(0, Math.min(reels.length - 1, Math.round(reelsEl.scrollTop / VIEW_H)));
    }

    reelsEl.addEventListener("scroll", () => {
      if (snapTimer) clearTimeout(snapTimer);
      snapTimer = setTimeout(() => {
        const idx = nearestIndex();
        const targetTop = idx * VIEW_H;
        // hard align if off by more than 2px
        if (Math.abs(reelsEl.scrollTop - targetTop) > 2){
          animateTo(targetTop, 240);
        }
        activate(idx);
      }, 70);
    }, { passive:true });

    // Small swipe should still go 1 reel (ohne "extrem schnell")
    let touchStartY = 0;
    let touchStartTop = 0;

    reelsEl.addEventListener("touchstart", (e) => {
      const t = e.touches?.[0];
      if (!t) return;
      touchStartY = t.clientY;
      touchStartTop = reelsEl.scrollTop;
    }, { passive:true });

    reelsEl.addEventListener("touchend", (e) => {
      const t = e.changedTouches?.[0];
      if (!t) return;

      const dy = t.clientY - touchStartY;
      const dTop = reelsEl.scrollTop - touchStartTop;

      // If user made a small gesture but scroll didn't "commit": force 1 step
      const smallGesture = Math.abs(dy) > 18 && Math.abs(dTop) < VIEW_H * 0.12;
      if (!smallGesture) return;

      const dir = dy < 0 ? 1 : -1;
      const idx = nearestIndex();
      const next = Math.max(0, Math.min(reels.length - 1, idx + dir));
      animateTo(next * VIEW_H, 240);
      activate(next);
    }, { passive:true });

    // =========================================================
    // 6) Controls
    // =========================================================
    document.addEventListener("click", (e) => {
      const actionEl = e.target.closest("[data-action]");
      if (!actionEl) return;

      const action = actionEl.getAttribute("data-action");
      if (action === "back"){
        window.location.href = "./karte-demo.html";
        return;
      }

      if (action === "sound"){
        soundOn = !soundOn;
        localStorage.setItem(SOUND_KEY, soundOn ? "on" : "off");
        applySound();
        // important: do NOT restart, just keep playing
        safePlay(videos[activeIndex]);
        toast(soundOn ? "Sound: ON" : "Sound: OFF");
        return;
      }

      if (action === "like"){
        const btn = actionEl.closest('.railBtn[data-action="like"]');
        if (!btn) return;
        const countEl = btn.querySelector(".railCount");
        const cur = parseInt(btn.getAttribute("data-count") || "0", 10) || 0;
        const liked = btn.classList.toggle("is-liked");
        const next = liked ? cur + 1 : Math.max(0, cur - 1);
        btn.setAttribute("data-count", String(next));
        if (countEl) countEl.textContent = String(next);
        return;
      }

      if (action === "comment"){ alert("Comments (demo)"); return; }
      if (action === "share"){ alert("Share (demo)"); return; }
      if (action === "product"){ alert("Produkt öffnen (demo)"); return; }
    }, { passive:true });

    // Double-tap like
    let lastTap = 0;
    document.addEventListener("touchend", (e) => {
      const now = Date.now();
      const isDouble = (now - lastTap) < 260;
      lastTap = now;
      if (!isDouble) return;

      const reel = e.target.closest(".reel");
      if (!reel) return;
      const likeBtn = reel.querySelector('.railBtn[data-action="like"]');
      likeBtn?.click();
    }, { passive:true });

    // Pause when hidden
    document.addEventListener("visibilitychange", () => {
      if (document.hidden){
        videos.forEach(v => { try { v.pause(); } catch(_){} });
      } else {
        warmAround(activeIndex);
        applySound();
        safePlay(videos[activeIndex]);
      }
    }, { passive:true });

    // =========================================================
    // 7) IntersectionObserver (stable active index)
    // =========================================================
    const io = new IntersectionObserver((entries) => {
      let best = null;
      for (const e of entries){
        if (!e.isIntersecting) continue;
        if (!best || e.intersectionRatio > best.intersectionRatio) best = e;
      }
      if (!best) return;
      const idx = Number(best.target.dataset.index || "0");
      if (Number.isFinite(idx)) activate(idx);
    }, { threshold: [0.55, 0.7, 0.85] });

    reels.forEach(r => io.observe(r));

    // =========================================================
    // 8) INIT (instant)
    // =========================================================
    await waitForHlsJs();     // ensures Chrome can play m3u8
    attachStallFix();

    // Start fast: prepare 0,1,2 immediately
    warmAround(0);
    applySound();
    safePlay(videos[0]);
  </script>
</body>
</html>
