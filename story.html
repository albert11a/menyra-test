<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>MENYRA â€“ Story (Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <style>
    :root{
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
      --sar: env(safe-area-inset-right, 0px);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html, body{ height:100%; background:#000; }
    body{ overflow:hidden; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* =========================================================
       APP WRAPPER (fixed) â€“ verhindert "letzte mm langsam"
    ========================================================= */
    .storyApp{
      position:fixed;
      inset:0;
      background:#000;
      overflow:hidden;
    }

    /* Scroll Container */
    .reels{
      height:100vh;
      height:100svh;
      height:100dvh;
      overflow-y:auto;
      scroll-snap-type:y mandatory;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;

      scrollbar-width:none;
    }
    .reels::-webkit-scrollbar{ display:none; }

    /* Each reel = exakt viewport height (fix fÃ¼r Snap + Browser UI) */
    .reel{
      position:relative;
      height:100vh;
      height:100svh;
      height:100dvh;
      width:100%;
      scroll-snap-align:start;
      scroll-snap-stop:always;
      background:#000;
    }

    /* Video full */
    .reelVideo{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      background:#000;
    }

    /* =========================================================
       TOP BAR (safe area)
    ========================================================= */
    .topBar{
      position:absolute;
      left:0; right:0;
      top:0;
      padding-top: calc(10px + var(--sat));
      padding-left: calc(12px + var(--sal));
      padding-right: calc(12px + var(--sar));
      padding-bottom: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      z-index: 5;
      pointer-events:none;
    }
    .topLeft{
      display:flex;
      align-items:center;
      gap:10px;
      pointer-events:auto;
    }

    .backBtn{
      width:42px;
      height:42px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      display:grid;
      place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .backBtn:active{ transform:scale(.98); }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      max-width: 70vw;
    }
    .brandLogo{
      width:34px;
      height:34px;
      border-radius:10px;
      background:#111;
      border:1px solid rgba(255,255,255,.12);
      object-fit:contain;
    }
    .brandName{
      font-weight:750;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.95;
    }

    .topRight{
      pointer-events:auto;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pillBtn{
      height:42px;
      border-radius:14px;
      padding:0 12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      color:#fff;
      font-weight:750;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      -webkit-tap-highlight-color: transparent;
    }
    .pillBtn:active{ transform:scale(.98); }
    .pillDot{
      width:8px; height:8px; border-radius:999px;
      background:#fff;
      opacity:.85;
    }

    /* =========================================================
       RIGHT RAIL (TikTok style)
    ========================================================= */
    .rail{
      position:absolute;
      right: calc(10px + var(--sar));
      bottom: calc(110px + var(--sab));
      display:flex;
      flex-direction:column;
      gap:14px;
      z-index:5;
      pointer-events:auto;
    }
    .railBtn{
      width:52px;
      height:52px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.30);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:2px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .railBtn:active{ transform:scale(.98); }
    .railIcon{
      width:22px; height:22px;
      display:block;
      fill:#fff;
      opacity:.95;
    }
    .railCount{
      font-size:11px;
      font-weight:800;
      opacity:.9;
      line-height:1;
    }
    .railBtn.is-liked .railIcon{ fill:#ff5a5f; }
    .railBtn.is-liked .railCount{ color:#ff5a5f; }

    /* =========================================================
       BOTTOM PRODUCT CARD (safe area)
    ========================================================= */
    .productCard{
      position:absolute;
      left: calc(12px + var(--sal));
      right: calc(12px + var(--sar));
      bottom: calc(14px + var(--sab));
      z-index:5;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding:12px;
      display:flex;
      align-items:center;
      gap:12px;
      pointer-events:auto;
    }
    .productImg{
      width:54px;
      height:54px;
      border-radius:14px;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.12);
      background:#111;
      flex: 0 0 auto;
    }
    .productMeta{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
      flex:1;
    }
    .productTitle{
      font-size:13px;
      font-weight:850;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .productSub{
      font-size:12px;
      opacity:.85;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .productArrow{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }
    .productArrow svg{ width:18px; height:18px; fill:#fff; opacity:.95; }

    /* Pause hint */
    .pauseHint{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%, -50%);
      z-index:5;
      width:74px;
      height:74px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      display:none;
      place-items:center;
      pointer-events:none;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .pauseHint svg{ width:26px; height:26px; fill:#fff; opacity:.95; }
    .reel.is-paused .pauseHint{ display:grid; }

    /* =========================================================
       COMMENTS SHEET (demo sichtbar)
    ========================================================= */
    .sheetBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 20;
    }
    .commentSheet{
      position:fixed;
      left:0; right:0;
      bottom:0;
      transform: translateY(105%);
      transition: transform .22s ease;
      z-index: 21;

      padding-left: calc(12px + var(--sal));
      padding-right: calc(12px + var(--sar));
      padding-bottom: calc(12px + var(--sab));

      will-change: transform;
    }
    .commentSheetInner{
      border-radius: 22px 22px 0 0;
      background:#0b0f1a;
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      max-height: calc(70vh + var(--sab));
      max-height: calc(70svh + var(--sab));
      max-height: calc(70dvh + var(--sab));
      display:flex;
      flex-direction:column;
    }
    .sheetHeader{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .sheetTitle{
      font-weight:900;
      font-size:13px;
      opacity:.95;
    }
    .sheetClose{
      width:40px;
      height:40px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      display:grid;
      place-items:center;
      -webkit-tap-highlight-color: transparent;
    }
    .sheetClose svg{ width:18px; height:18px; fill:#fff; opacity:.9; }

    .sheetList{
      padding: 10px 14px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .cRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .cAvatar{
      width:34px;
      height:34px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
      display:grid;
      place-items:center;
      font-weight:900;
      font-size:12px;
      opacity:.95;
    }
    .cBody{
      min-width:0;
      flex:1;
    }
    .cName{
      font-weight:900;
      font-size:12px;
      opacity:.95;
      margin-bottom:2px;
    }
    .cText{
      font-size:12px;
      opacity:.85;
      line-height:1.35;
    }

    .sheetInputRow{
      padding: 12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .sheetInput{
      flex:1;
      height:42px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:#fff;
      padding: 0 12px;
      outline:none;
      font-size:12px;
    }
    .sheetSend{
      height:42px;
      padding:0 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.10);
      color:#fff;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    /* Open state */
    html.comments-open .sheetBackdrop{
      opacity:1;
      pointer-events:auto;
    }
    html.comments-open .commentSheet{
      transform: translateY(0);
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(88px + var(--sab));
      transform: translateX(-50%) translateY(10px);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight:800;
      font-size:12px;
      opacity:0;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 25;
      pointer-events:none;
      white-space:nowrap;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(0);
    }

    @media (prefers-reduced-motion: reduce){
      .commentSheet, .sheetBackdrop, .toast{ transition:none !important; }
    }
  </style>
</head>

<body>
  <main class="storyApp">
    <section class="reels" id="reels">

      <!-- REEL 1 -->
      <article class="reel"
        data-index="0"
        data-name="Prince Coffe House"
        data-logo="./images/Prince-coffe-house-logo.jpg"
        data-like="128"
        data-comments="34"
        data-product-title="Burger + Fries"
        data-product-sub="5.90 â‚¬ â€¢ Tap to view product"
        data-product-img="./images/Prince-coffe-house-offer.jpg"
      >
        <video class="reelVideo" src="./images/tik1.mp4" playsinline muted loop preload="metadata"></video>
        <div class="pauseHint" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M8 5h3v14H8V5zm5 0h3v14h-3V5z"/></svg>
        </div>
      </article>

      <!-- REEL 2 -->
      <article class="reel"
        data-index="1"
        data-name="Prince Coffe House"
        data-logo="./images/Prince-coffe-house-logo.jpg"
        data-like="76"
        data-comments="18"
        data-product-title="Special Coffee"
        data-product-sub="2.90 â‚¬ â€¢ Tap to view product"
        data-product-img="./images/Prince-coffe-house-logo.jpg"
      >
        <video class="reelVideo" src="./images/tik2.mp4" playsinline muted loop preload="metadata"></video>
        <div class="pauseHint" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M8 5h3v14H8V5zm5 0h3v14h-3V5z"/></svg>
        </div>
      </article>

      <!-- REEL 3 -->
      <article class="reel"
        data-index="2"
        data-name="Prince Coffe House"
        data-logo="./images/Prince-coffe-house-logo.jpg"
        data-like="210"
        data-comments="52"
        data-product-title="Dessert"
        data-product-sub="4.60 â‚¬ â€¢ Tap to view product"
        data-product-img="./images/Prince-coffe-house-offer.jpg"
      >
        <video class="reelVideo" src="./images/tik3.mp4" playsinline muted loop preload="metadata"></video>
        <div class="pauseHint" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M8 5h3v14H8V5zm5 0h3v14h-3V5z"/></svg>
        </div>
      </article>

    </section>
  </main>

  <!-- Backdrop + Sheet -->
  <div class="sheetBackdrop" id="sheetBackdrop" aria-hidden="true"></div>

  <section class="commentSheet" id="commentSheet" aria-hidden="true">
    <div class="commentSheetInner" role="dialog" aria-label="Kommentare">
      <div class="sheetHeader">
        <div class="sheetTitle" id="sheetTitle">Kommentare</div>
        <button class="sheetClose" id="sheetCloseBtn" type="button" aria-label="Close">
          <svg viewBox="0 0 24 24"><path d="M18.3 5.7 12 12l6.3 6.3-1.6 1.6L10.4 13.6 4.1 19.9 2.5 18.3 8.8 12 2.5 5.7 4.1 4.1l6.3 6.3 6.3-6.3 1.6 1.6z"/></svg>
        </button>
      </div>

      <div class="sheetList" id="sheetList">
        <!-- JS fills demo comments -->
      </div>

      <div class="sheetInputRow">
        <input class="sheetInput" type="text" placeholder="Write a commentâ€¦ (demo)" disabled />
        <button class="sheetSend" type="button" disabled>Send</button>
      </div>
    </div>
  </section>

  <!-- Overlay Template (topbar + rail + product) -->
  <template id="overlayTpl">
    <div class="topBar">
      <div class="topLeft">
        <button class="backBtn" type="button" data-action="back" aria-label="Back">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="#fff" aria-hidden="true">
            <path d="M15.5 19.5 8 12l7.5-7.5 1.8 1.8L11.6 12l5.7 5.7-1.8 1.8z"/>
          </svg>
        </button>

        <div class="brand" aria-label="Brand">
          <img class="brandLogo" data-bind="logo" alt="Logo" />
          <div class="brandName" data-bind="name">Restaurant</div>
        </div>
      </div>

      <div class="topRight">
        <button class="pillBtn" type="button" data-action="sound" aria-label="Sound toggle">
          <span class="pillDot" aria-hidden="true"></span>
          <span id="soundLabel">Sound</span>
        </button>
      </div>
    </div>

    <div class="rail" aria-label="Actions">
      <button class="railBtn" type="button" data-action="like" aria-label="Like">
        <svg class="railIcon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 21s-7-4.6-9.6-8.7C.8 9.4 2.1 6.6 4.7 5.6c1.7-.7 3.7-.2 5 1.2L12 9l2.3-2.2c1.3-1.4 3.3-1.9 5-1.2 2.6 1 3.9 3.8 2.3 6.7C19 16.4 12 21 12 21z"/>
        </svg>
        <div class="railCount" data-bind="likeCount">0</div>
      </button>

      <button class="railBtn" type="button" data-action="comment" aria-label="Comments">
        <svg class="railIcon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 4h16v12H7l-3 3V4zm3 5h10v2H7V9zm0 4h7v2H7v-2z"/>
        </svg>
        <div class="railCount" data-bind="commentCount">0</div>
      </button>

      <button class="railBtn" type="button" data-action="share" aria-label="Share">
        <svg class="railIcon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M18 8a3 3 0 10-2.8-4H15a3 3 0 003 3zM6 14a3 3 0 10-2.8-4H3a3 3 0 003 3zm12 10a3 3 0 10-2.8-4H15a3 3 0 003 3zM8.7 12.2l6.6-3.4-.9-1.8-6.6 3.4.9 1.8zm6.6 4l-6.6-3.4-.9 1.8 6.6 3.4.9-1.8z"/>
        </svg>
      </button>
    </div>

    <div class="productCard" role="button" tabindex="0" data-action="product" aria-label="Marked product">
      <img class="productImg" data-bind="productImg" alt="Product" />
      <div class="productMeta">
        <div class="productTitle" data-bind="productTitle">Produkt</div>
        <div class="productSub" data-bind="productSub">Tap to view</div>
      </div>
      <div class="productArrow" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M9 6l6 6-6 6-1.6-1.6L11.8 12 7.4 7.6 9 6z"/></svg>
      </div>
    </div>
  </template>

  <div class="toast" id="toast">Sound</div>

  <script type="module">
    // =========================================================
    // ABSCHNITT JS 1: Overlay in alle Reels injizieren (schnell)
    // =========================================================
    const tpl = document.getElementById("overlayTpl");
    const reels = Array.from(document.querySelectorAll(".reel"));
    const videos = Array.from(document.querySelectorAll(".reelVideo"));
    const toastEl = document.getElementById("toast");

    const sheetBackdrop = document.getElementById("sheetBackdrop");
    const commentSheet = document.getElementById("commentSheet");
    const sheetCloseBtn = document.getElementById("sheetCloseBtn");
    const sheetList = document.getElementById("sheetList");
    const sheetTitle = document.getElementById("sheetTitle");

    reels.forEach((reel) => {
      const frag = tpl.content.cloneNode(true);

      const name = reel.getAttribute("data-name") || "Restaurant";
      const logo = reel.getAttribute("data-logo") || "";
      const like = reel.getAttribute("data-like") || "0";
      const comments = reel.getAttribute("data-comments") || "0";
      const pTitle = reel.getAttribute("data-product-title") || "Produkt";
      const pSub = reel.getAttribute("data-product-sub") || "Tap to view product";
      const pImg = reel.getAttribute("data-product-img") || "";

      const logoEl = frag.querySelector('[data-bind="logo"]');
      const nameEl = frag.querySelector('[data-bind="name"]');
      const likeCountEl = frag.querySelector('[data-bind="likeCount"]');
      const commentCountEl = frag.querySelector('[data-bind="commentCount"]');
      const pTitleEl = frag.querySelector('[data-bind="productTitle"]');
      const pSubEl = frag.querySelector('[data-bind="productSub"]');
      const pImgEl = frag.querySelector('[data-bind="productImg"]');

      if (logoEl && logo) logoEl.src = logo;
      if (nameEl) nameEl.textContent = name;

      const likeBtn = frag.querySelector('.railBtn[data-action="like"]');
      if (likeBtn) likeBtn.setAttribute("data-count", String(parseInt(like,10)||0));
      if (likeCountEl) likeCountEl.textContent = String(parseInt(like,10)||0);

      const comBtn = frag.querySelector('.railBtn[data-action="comment"]');
      if (comBtn) comBtn.setAttribute("data-count", String(parseInt(comments,10)||0));
      if (commentCountEl) commentCountEl.textContent = String(parseInt(comments,10)||0);

      if (pTitleEl) pTitleEl.textContent = pTitle;
      if (pSubEl) pSubEl.textContent = pSub;
      if (pImgEl && pImg) pImgEl.src = pImg;

      reel.appendChild(frag);
    });

    // =========================================================
    // ABSCHNITT JS 2: Autoplay nur fÃ¼r aktives Reel
    // =========================================================
    const SOUND_KEY = "menyra_story_sound"; // "on" | "off"
    let soundOn = (localStorage.getItem(SOUND_KEY) || "off") === "on";
    let activeIndex = 0;

    function showToast(text){
      if (!toastEl) return;
      toastEl.textContent = text;
      toastEl.classList.add("show");
      window.setTimeout(() => toastEl.classList.remove("show"), 650);
    }

    function setSoundState(on){
      soundOn = !!on;
      localStorage.setItem(SOUND_KEY, soundOn ? "on" : "off");
      videos.forEach((v, i) => v.muted = !(soundOn && i === activeIndex));
      showToast(soundOn ? "Sound: ON" : "Sound: OFF");
    }

    async function playOnly(index){
      activeIndex = index;

      videos.forEach((v, i) => {
        const reel = reels[i];
        if (i !== index){
          v.pause();
          v.muted = true;
          reel?.classList.remove("is-paused");
        }
      });

      const v = videos[index];
      if (!v) return;

      // sound only on active
      v.muted = !soundOn;

      try{
        await v.play();
        reels[index]?.classList.remove("is-paused");
      }catch(_){
        // iOS kann blocken â€“ bleibt pausiert, user tappt dann
        reels[index]?.classList.add("is-paused");
      }
    }

    // =========================================================
    // ABSCHNITT JS 3: SMART BACK (Demo-Fallback karte-demo.html)
    // =========================================================
    const BACK_FALLBACK = (() => {
      const qs = new URLSearchParams(window.location.search);
      const back = (qs.get("back") || "").trim();
      return back || "./karte-demo.html";
    })();

    function goBackSmart(){
      if (window.history.length > 1) {
        window.history.back();
        return;
      }
      window.location.href = BACK_FALLBACK;
    }

    // init
    setSoundState(soundOn);
    playOnly(0);

    // observer â†’ findet aktives Reel sauber (kein "letzte mm langsam")
    const io = new IntersectionObserver((entries) => {
      let best = null;
      for (const e of entries){
        if (!e.isIntersecting) continue;
        if (!best || e.intersectionRatio > best.intersectionRatio) best = e;
      }
      if (!best) return;
      const idx = Number(best.target.getAttribute("data-index") || "0");
      if (Number.isFinite(idx) && idx !== activeIndex){
        playOnly(idx);
      }
    }, { threshold: [0.55, 0.75, 0.9] });

    reels.forEach(r => io.observe(r));

    // =========================================================
    // ABSCHNITT JS 4: Comments Sheet (sichtbar Demo)
    // =========================================================
    function fillDemoComments(reel){
      const name = reel?.getAttribute("data-name") || "Prince Coffe House";
      const count = parseInt(reel?.getAttribute("data-comments") || "0", 10) || 0;

      if (sheetTitle) sheetTitle.textContent = `Kommentare (${count})`;

      const demo = [
        { n:"Ardi", t:"Shume e mire ðŸ”¥" },
        { n:"Lira", t:"A ka edhe sauce extra?" },
        { n:"Beni", t:"Kjo duket super!" },
        { n:"Sara", t:"Sa shpejt vjen porosia?" },
        { n:"Erion", t:"Top, do vij prape ðŸ‘Œ" },
      ];

      sheetList.innerHTML = demo.map(x => `
        <div class="cRow">
          <div class="cAvatar">${x.n.slice(0,1).toUpperCase()}</div>
          <div class="cBody">
            <div class="cName">${x.n} <span style="opacity:.55;font-weight:800;">â€¢ ${name}</span></div>
            <div class="cText">${x.t}</div>
          </div>
        </div>
      `).join("");
    }

    function openComments(){
      const reel = reels[activeIndex];
      fillDemoComments(reel);

      document.documentElement.classList.add("comments-open");
      commentSheet?.setAttribute("aria-hidden", "false");
      sheetBackdrop?.setAttribute("aria-hidden", "false");

      // optional: pause while reading comments (schneller/ruhiger)
      videos[activeIndex]?.pause();
      reels[activeIndex]?.classList.add("is-paused");
    }

    function closeComments(){
      document.documentElement.classList.remove("comments-open");
      commentSheet?.setAttribute("aria-hidden", "true");
      sheetBackdrop?.setAttribute("aria-hidden", "true");

      // resume
      playOnly(activeIndex);
    }

    sheetBackdrop?.addEventListener("click", closeComments, { passive:true });
    sheetCloseBtn?.addEventListener("click", closeComments, { passive:true });

    // =========================================================
    // ABSCHNITT JS 5: Global click delegation (super schnell)
    // =========================================================
    document.addEventListener("click", (e) => {
      const actionEl = e.target.closest("[data-action]");
      if (actionEl){
        const action = actionEl.getAttribute("data-action");

        if (action === "back"){
          goBackSmart();
          return;
        }

        if (action === "sound"){
          setSoundState(!soundOn);
          playOnly(activeIndex);
          return;
        }

        if (action === "like"){
          const btn = actionEl.closest('.railBtn[data-action="like"]');
          if (!btn) return;

          const countEl = btn.querySelector(".railCount");
          const cur = parseInt(btn.getAttribute("data-count") || "0", 10) || 0;
          const liked = btn.classList.toggle("is-liked");
          const next = liked ? cur + 1 : Math.max(0, cur - 1);

          btn.setAttribute("data-count", String(next));
          if (countEl) countEl.textContent = String(next);
          return;
        }

        if (action === "comment"){
          openComments();
          return;
        }

        if (action === "share"){
          showToast("Share (demo)");
          return;
        }

        if (action === "product"){
          showToast("Produkt Ã¶ffnen (demo)");
          return;
        }
      }

      // Tap on video â†’ play/pause
      const video = e.target.closest("video.reelVideo");
      if (!video) return;

      const reel = video.closest(".reel");
      const idx = Number(reel?.getAttribute("data-index") || "0");

      // wenn user tippt und comments offen sind â†’ ignorieren
      if (document.documentElement.classList.contains("comments-open")) return;

      if (video.paused){
        playOnly(Number.isFinite(idx) ? idx : activeIndex);
      }else{
        video.pause();
        reel?.classList.add("is-paused");
      }
    }, { passive:true });

    // Double tap to like
    let lastTap = 0;
    document.addEventListener("touchend", (e) => {
      if (document.documentElement.classList.contains("comments-open")) return;

      const now = Date.now();
      const isDouble = (now - lastTap) < 260;
      lastTap = now;
      if (!isDouble) return;

      const reel = e.target.closest(".reel");
      if (!reel) return;

      const likeBtn = reel.querySelector('.railBtn[data-action="like"]');
      if (likeBtn) likeBtn.click();
    }, { passive:true });

    // Pause when hidden
    document.addEventListener("visibilitychange", () => {
      if (document.hidden){
        videos.forEach(v => v.pause());
      }else{
        playOnly(activeIndex);
      }
    }, { passive:true });

    // ESC closes comments (desktop)
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && document.documentElement.classList.contains("comments-open")){
        closeComments();
      }
    });
  </script>
</body>
</html>
