<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>MENYRA ‚Äì Story</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />

  <!-- Priorisiere nur Reel 1 -->
  <link rel="preload" as="video" href="./images/tik1.mp4" type="video/mp4" fetchpriority="high">
  <link rel="preload" as="image" href="./images/Prince-coffe-house-logo.jpg">
  <link rel="preload" as="image" href="./images/Prince-coffe-house-offer.jpg">

  <style>
    :root{
      --vh: 100dvh;
      --st: env(safe-area-inset-top, 0px);
      --sb: env(safe-area-inset-bottom, 0px);
      --txt: rgba(255,255,255,.92);
      --sub: rgba(255,255,255,.68);
      --glass: rgba(0,0,0,.30);
      --line: rgba(255,255,255,.14);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:#000;color:#fff}
    body{overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    button{font:inherit;color:inherit;background:none;border:0}
    img{display:block;max-width:100%}

    .app{position:fixed;inset:0;height:var(--vh);background:#000;overflow:hidden}

    /* FEED: wir scrollen per scrollTop (keine transforms auf Video!) */
    .feed{
      position:absolute; inset:0;
      height:var(--vh);
      overflow:hidden;            /* user kann nicht ‚Äúmomentum-scrollen‚Äù */
      touch-action:none;          /* wir √ºbernehmen swipe */
      -webkit-tap-highlight-color: transparent;
    }

    .reel{
      position:relative;
      height:var(--vh);
      width:100%;
      background:#000;
      overflow:hidden;
    }
    .reelVideo{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      background:#000;
      display:block;
    }

    /* COVER: bleibt bis erstes Video-Frame wirklich da ist */
    .cover{
      position:absolute; inset:0; z-index:3;
      background:#000;
      display:block;
    }
    .coverImg{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      transform: translateZ(0);
    }
    .cover.is-hidden{
      opacity:0;
      pointer-events:none;
      transition: opacity 120ms ease;
    }

    .topFade,.botFade{position:fixed;left:0;right:0;pointer-events:none;z-index:5}
    .topFade{top:0;height:34%;background:linear-gradient(to bottom,rgba(0,0,0,.62),rgba(0,0,0,0))}
    .botFade{bottom:0;height:44%;background:linear-gradient(to top,rgba(0,0,0,.74),rgba(0,0,0,0))}

    .hdr{
      position:fixed;z-index:10;
      top:calc(10px + var(--st));
      left:10px;right:10px;
      display:flex;align-items:center;gap:10px;
    }
    .iconBtn{
      width:40px;height:40px;border-radius:14px;
      border:1px solid var(--line);
      background:var(--glass);
      display:grid;place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .iconBtn:active{transform:scale(.985)}
    .logo{
      width:30px;height:30px;border-radius:10px;object-fit:contain;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
    }
    .titleWrap{min-width:0;display:flex;flex-direction:column;line-height:1.05}
    .title{font-weight:900;font-size:14px;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .subtitle{font-size:12px;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .spacer{flex:1}

    .actions{
      position:fixed;z-index:10;
      right:10px;
      bottom:calc(110px + var(--sb));
      display:flex;flex-direction:column;gap:10px;
    }
    .actionBtn{
      width:52px;border:1px solid var(--line);
      background:var(--glass);
      border-radius:18px;padding:10px 8px;
      display:flex;flex-direction:column;align-items:center;gap:6px;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .actionBtn:active{transform:scale(.985)}
    .actionIcon{width:22px;height:22px;display:block}
    .actionLabel{font-size:11px;font-weight:900;color:var(--txt)}

    .caption{
      position:fixed;z-index:10;
      left:12px;
      bottom:calc(98px + var(--sb));
      max-width:72%;
    }
    .capUser{font-size:14px;font-weight:900;color:var(--txt);margin-bottom:6px}
    .capText{font-size:13px;line-height:1.35;color:rgba(255,255,255,.82)}

    .productCard{
      position:fixed;z-index:12;
      left:12px;right:76px;
      bottom:calc(18px + var(--sb));
      border-radius:18px;border:1px solid var(--line);
      background:rgba(0,0,0,.34);
      padding:10px;display:flex;gap:10px;align-items:center;overflow:hidden;
    }
    .productImg{
      width:54px;height:54px;border-radius:14px;object-fit:cover;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .productMeta{min-width:0;display:flex;flex-direction:column;gap:3px;flex:1}
    .productName{font-size:13px;font-weight:900;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .productSub{font-size:12px;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .productBtn{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.92);
      height:38px;padding:0 12px;border-radius:14px;
      font-size:12px;font-weight:900;cursor:pointer;white-space:nowrap;
      -webkit-tap-highlight-color:transparent;
    }
    .productBtn:active{transform:scale(.985)}

    /* comments demo */
    .backdrop{
      position:fixed;inset:0;z-index:50;
      background:#000;opacity:0;pointer-events:none;
      transition:opacity 160ms ease;
    }
    .backdrop.open{opacity:.85;pointer-events:auto}
    .sheet{
      position:fixed;left:0;right:0;bottom:0;z-index:60;
      height:min(70dvh,520px);
      background:#000;
      border-top-left-radius:22px;border-top-right-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      transform:translateY(110%);
      transition:transform 200ms ease;
      padding-bottom:var(--sb);
      display:flex;flex-direction:column;overflow:hidden;
    }
    .sheet.open{transform:translateY(0)}
    .sheetTop{
      padding:12px 12px 10px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .sheetTitle{font-size:13px;font-weight:900;color:var(--txt)}
    .sheetList{padding:10px 12px;overflow:auto;flex:1}
    .cItem{
      padding:10px 10px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      margin-bottom:10px;
    }
    .cUser{font-size:12px;font-weight:900;color:var(--txt);margin-bottom:4px}
    .cText{font-size:12px;color:rgba(255,255,255,.78);line-height:1.35}
    .sheetInput{
      padding:10px 12px 12px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;gap:10px;align-items:center;
    }
    .sheetInput input{
      flex:1;height:42px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      padding:0 12px;outline:none;font-size:13px;
    }
    @media (prefers-reduced-motion: reduce){
      .cover, .sheet, .backdrop{transition:none!important}
    }
  </style>
</head>

<body>
  <div class="app" id="app">

    <div class="feed" id="feed" aria-label="Story Feed">
      <!-- Reel 1 -->
      <section class="reel" data-i="0">
        <video class="reelVideo"
          playsinline webkit-playsinline
          muted autoplay
          preload="auto"
          poster="./images/Prince-coffe-house-offer.jpg"
          disablepictureinpicture
        >
          <source src="./images/tik1.mp4" type="video/mp4">
        </video>
        <div class="cover">
          <img class="coverImg" src="./images/Prince-coffe-house-offer.jpg" alt="" />
        </div>
      </section>

      <!-- Reel 2 -->
      <section class="reel" data-i="1">
        <video class="reelVideo"
          playsinline webkit-playsinline
          muted autoplay
          preload="auto"
          poster="./images/Prince-coffe-house-offer.jpg"
          disablepictureinpicture
        >
          <source src="./images/tik2.mp4" type="video/mp4">
        </video>
        <div class="cover">
          <img class="coverImg" src="./images/Prince-coffe-house-offer.jpg" alt="" />
        </div>
      </section>

      <!-- Reel 3 -->
      <section class="reel" data-i="2">
        <video class="reelVideo"
          playsinline webkit-playsinline
          muted autoplay
          preload="auto"
          poster="./images/Prince-coffe-house-offer.jpg"
          disablepictureinpicture
        >
          <source src="./images/tik3.mp4" type="video/mp4">
        </video>
        <div class="cover">
          <img class="coverImg" src="./images/Prince-coffe-house-offer.jpg" alt="" />
        </div>
      </section>
    </div>

    <div class="topFade" aria-hidden="true"></div>
    <div class="botFade" aria-hidden="true"></div>

    <!-- HEADER -->
    <div class="hdr">
      <button class="iconBtn" id="backBtn" type="button" aria-label="Zur√ºck">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="rgba(255,255,255,0.92)" d="M15.5 19.5 8 12l7.5-7.5 1.8 1.8L11.6 12l5.7 5.7-1.8 1.8z"/>
        </svg>
      </button>

      <img class="logo" src="./images/Prince-coffe-house-logo.jpg" alt="Logo" />

      <div class="titleWrap">
        <div class="title" id="hdrTitle">Prince Coffe House</div>
        <div class="subtitle" id="hdrSub">Story</div>
      </div>

      <div class="spacer"></div>

      <button class="iconBtn" id="soundBtn" type="button" aria-label="Ton umschalten">
        <svg id="soundIcon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"></svg>
      </button>
    </div>

    <!-- ACTIONS -->
    <div class="actions">
      <button class="actionBtn" id="likeBtn" type="button">
        <svg class="actionIcon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="rgba(255,255,255,0.92)" d="M12 21s-7-4.6-9.5-9C.7 8.2 3 5 6.4 5c1.9 0 3.2 1 3.6 1.6.4-.6 1.7-1.6 3.6-1.6C17 5 19.3 8.2 21.5 12 19 16.4 12 21 12 21z"/>
        </svg>
        <div class="actionLabel" id="likeCount">0</div>
      </button>

      <button class="actionBtn" id="commentBtn" type="button">
        <svg class="actionIcon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="rgba(255,255,255,0.92)" d="M4 4h16v11H7.2L4 18.2V4z"/>
        </svg>
        <div class="actionLabel" id="commentCount">0</div>
      </button>
    </div>

    <!-- CAPTION -->
    <div class="caption">
      <div class="capUser" id="capUser">@princecoffeehouse</div>
      <div class="capText" id="capText">‚Ä¶</div>
    </div>

    <!-- PRODUCT -->
    <div class="productCard">
      <img class="productImg" id="prodImg" src="./images/Prince-coffe-house-offer.jpg" alt="Produkt" />
      <div class="productMeta">
        <div class="productName" id="prodName">‚Ä¶</div>
        <div class="productSub" id="prodSub">‚Ä¶</div>
      </div>
      <button class="productBtn" type="button">Shiko</button>
    </div>

    <!-- COMMENTS -->
    <div class="backdrop" id="backdrop" aria-hidden="true"></div>
    <section class="sheet" id="sheet" aria-hidden="true">
      <div class="sheetTop">
        <div class="sheetTitle">Komentet</div>
        <button class="iconBtn" id="sheetCloseBtn" type="button" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="rgba(255,255,255,0.92)" d="M18.3 5.7 12 12l6.3 6.3-1.3 1.3L10.7 13.3 4.4 19.6 3.1 18.3 9.4 12 3.1 5.7 4.4 4.4l6.3 6.3L17 4.4l1.3 1.3z"/>
          </svg>
        </button>
      </div>
      <div class="sheetList">
        <div class="cItem"><div class="cUser">Ardi</div><div class="cText">üî•üî• super</div></div>
        <div class="cItem"><div class="cUser">Lina</div><div class="cText">Kur ka edhe sot?</div></div>
        <div class="cItem"><div class="cUser">Denis</div><div class="cText">Perfect vibe</div></div>
      </div>
      <div class="sheetInput">
        <input type="text" placeholder="Shkruaj koment‚Ä¶" />
        <button class="productBtn" type="button">Send</button>
      </div>
    </section>

  </div>

  <script type="module">
    const DATA = [
      { likes:128, comments:12, user:"@princecoffeehouse", text:"New drop üî• Burger + Fries today.", productName:"Burger + Fries", productSub:"5.90 ‚Ç¨ ‚Ä¢ Marked Product" },
      { likes:86,  comments:8,  user:"@princecoffeehouse", text:"Coffee vibes ‚òï smooth & strong.",        productName:"Cappuccino",   productSub:"2.90 ‚Ç¨ ‚Ä¢ Marked Product" },
      { likes:203, comments:21, user:"@princecoffeehouse", text:"Quick bite, big taste ‚úÖ",             productName:"Burger Menu",  productSub:"5.90 ‚Ç¨ ‚Ä¢ Marked Product" }
    ];

    const feed = document.getElementById("feed");
    const reels = Array.from(document.querySelectorAll(".reel"));
    const videos = reels.map(r => r.querySelector("video"));
    const covers = reels.map(r => r.querySelector(".cover"));

    const backBtn = document.getElementById("backBtn");
    const soundBtn = document.getElementById("soundBtn");
    const soundIcon = document.getElementById("soundIcon");

    const likeBtn = document.getElementById("likeBtn");
    const commentBtn = document.getElementById("commentBtn");
    const likeCount = document.getElementById("likeCount");
    const commentCount = document.getElementById("commentCount");

    const capUser = document.getElementById("capUser");
    const capText = document.getElementById("capText");
    const prodName = document.getElementById("prodName");
    const prodSub = document.getElementById("prodSub");

    const backdrop = document.getElementById("backdrop");
    const sheet = document.getElementById("sheet");
    const sheetCloseBtn = document.getElementById("sheetCloseBtn");

    // Safe height (Browser UI iOS/Android)
    function setVH(){
      const vv = window.visualViewport;
      const h = vv ? vv.height : window.innerHeight;
      document.documentElement.style.setProperty("--vh", h + "px");
      // auch section heights stabil halten
      reels.forEach(r => r.style.height = h + "px");
    }
    setVH();
    window.addEventListener("resize", setVH, { passive:true });
    if (window.visualViewport){
      visualViewport.addEventListener("resize", setVH, { passive:true });
      visualViewport.addEventListener("scroll", setVH, { passive:true });
    }

    // Back
    backBtn.addEventListener("click", (e) => {
      e.preventDefault();
      window.location.href = "./karte-demo.html";
    }, { passive:false });

    // Comments demo
    function openSheet(){
      backdrop.classList.add("open");
      sheet.classList.add("open");
      backdrop.setAttribute("aria-hidden","false");
      sheet.setAttribute("aria-hidden","false");
    }
    function closeSheet(){
      backdrop.classList.remove("open");
      sheet.classList.remove("open");
      backdrop.setAttribute("aria-hidden","true");
      sheet.setAttribute("aria-hidden","true");
    }
    commentBtn.addEventListener("click", openSheet, { passive:true });
    sheetCloseBtn.addEventListener("click", closeSheet, { passive:true });
    backdrop.addEventListener("click", closeSheet, { passive:true });

    // Sound toggle (Regel: Sound darf nicht automatisch starten -> nur User-Klick)
    const SOUND_KEY = "menyra_story_sound";
    let soundOn = (localStorage.getItem(SOUND_KEY) === "1");
    function renderSoundIcon(){
      soundIcon.innerHTML = soundOn
        ? `<path fill="rgba(255,255,255,.92)" d="M5 9v6h4l5 4V5L9 9H5Z"/><path fill="rgba(255,255,255,.92)" d="M16.5 7.5a7 7 0 0 1 0 9.9l-1.4-1.4a5 5 0 0 0 0-7.1l1.4-1.4z"/>`
        : `<path fill="rgba(255,255,255,.92)" d="M5 9v6h4l5 4V5L9 9H5Z"/><path fill="rgba(255,255,255,.62)" d="M19 8.6 17.6 10 20 12.4 17.6 14.8 19 16.2 22.8 12.4 19 8.6Z"/>`;
    }
    renderSoundIcon();

    // Playback helpers
    function hardStop(v){
      try{ v.pause(); }catch{}
      try{ v.currentTime = 0; }catch{}
      try{ v.muted = true; }catch{}
    }

    function hideCoverWhenReady(i){
      const v = videos[i];
      const c = covers[i];
      if (!v || !c) return;

      // Falls schon Frames da sind
      const tryHide = () => {
        // Sobald das Video wirklich spielt/Frames hat -> Cover weg
        c.classList.add("is-hidden");
      };

      // requestVideoFrameCallback = perfekter Indikator (wenn vorhanden)
      if ("requestVideoFrameCallback" in v){
        try{
          v.requestVideoFrameCallback(() => tryHide());
          return;
        }catch{}
      }

      // Fallback: loadeddata/playing
      v.addEventListener("loadeddata", tryHide, { once:true });
      v.addEventListener("playing", tryHide, { once:true });
    }

    async function playIndex(i){
      const v = videos[i];
      if (!v) return;

      // stop others to avoid ghost audio
      videos.forEach((ov, idx) => { if (idx !== i) hardStop(ov); });

      // cover sichtbar machen (falls zur√ºck geswiped)
      covers.forEach((c, idx) => {
        if (!c) return;
        if (idx === i) c.classList.remove("is-hidden");
      });

      // reset + mute based on toggle
      try{ v.pause(); }catch{}
      try{ v.currentTime = 0; }catch{}
      v.muted = !soundOn;

      // Prime (iOS): nach metadata tiny seek hilft schneller frame
      const prime = () => {
        try{
          if (v.duration && v.duration > 0) v.currentTime = 0.001;
        }catch{}
      };
      v.addEventListener("loadedmetadata", prime, { once:true });

      hideCoverWhenReady(i);

      // Play sofort (muted autoplay erlaubt)
      v.play().catch(() => {
        // Fallback: sobald canplay, nochmal
        const once = () => v.play().catch(()=>{});
        v.addEventListener("canplay", once, { once:true });
      });
    }

    function applyMeta(i){
      const d = DATA[i] || DATA[0];
      likeCount.textContent = String(d.likes);
      commentCount.textContent = String(d.comments);
      capUser.textContent = d.user;
      capText.textContent = d.text;
      prodName.textContent = d.productName;
      prodSub.textContent = d.productSub;
    }

    // Like demo
    likeBtn.addEventListener("click", () => {
      likeBtn.classList.toggle("is-liked");
      const base = DATA[active].likes;
      likeCount.textContent = String(likeBtn.classList.contains("is-liked") ? base + 1 : base);
    }, { passive:true });

    // Sound toggle
    soundBtn.addEventListener("click", (e) => {
      e.preventDefault();
      soundOn = !soundOn;
      localStorage.setItem(SOUND_KEY, soundOn ? "1" : "0");
      renderSoundIcon();
      const v = videos[active];
      if (v){
        v.muted = !soundOn;
        v.play().catch(()=>{});
      }
    }, { passive:false });

    // TikTok-like SNAP paging (no slow last mm)
    let active = 0;
    let H = 1;
    let dragging = false;
    let startY = 0;
    let baseTop = 0;
    let anim = null;

    function measure(){
      const vv = window.visualViewport;
      H = (vv ? vv.height : window.innerHeight) || 1;
      feed.scrollTop = active * H;
    }
    measure();
    window.addEventListener("resize", measure, { passive:true });

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function animateTo(top){
      if (anim) cancelAnimationFrame(anim);
      const from = feed.scrollTop;
      const to = top;
      const dur = 220; // fix & snappy like reels
      const t0 = performance.now();

      const step = (t) => {
        const p = clamp((t - t0) / dur, 0, 1);
        const eased = 1 - Math.pow(1 - p, 3);
        feed.scrollTop = from + (to - from) * eased;
        if (p < 1) anim = requestAnimationFrame(step);
      };
      anim = requestAnimationFrame(step);
    }

    function goTo(i){
      const ni = clamp(i, 0, reels.length - 1);
      active = ni;
      applyMeta(active);
      animateTo(active * H);
      playIndex(active);
    }

    // Pointer swipe
    feed.addEventListener("pointerdown", (e) => {
      if (sheet.classList.contains("open")) return;
      dragging = true;
      startY = e.clientY;
      baseTop = feed.scrollTop;
      try{ feed.setPointerCapture(e.pointerId); }catch{}
    }, { passive:true });

    feed.addEventListener("pointermove", (e) => {
      if (!dragging) return;
      const dy = e.clientY - startY;
      const next = clamp(baseTop - dy, 0, (reels.length - 1) * H);
      feed.scrollTop = next;
    }, { passive:true });

    feed.addEventListener("pointerup", (e) => {
      if (!dragging) return;
      dragging = false;

      const dy = e.clientY - startY;
      const threshold = H * 0.14;

      if (dy > threshold) goTo(active - 1);
      else if (dy < -threshold) goTo(active + 1);
      else goTo(active);
    }, { passive:true });

    feed.addEventListener("pointercancel", () => {
      if (!dragging) return;
      dragging = false;
      goTo(active);
    }, { passive:true });

    // ESC closes comments
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeSheet();
    });

    // Visibility: stop all
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) videos.forEach(hardStop);
      else playIndex(active);
    }, { passive:true });

    // INIT: sofort Reel 1 starten (muted autoplay)
    applyMeta(0);
    // wichtig: kurze microtask -> stabiler autostart
    queueMicrotask(() => playIndex(0));
  </script>
</body>
</html>
