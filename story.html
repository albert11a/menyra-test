<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>MENYRA ‚Äì Story</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />

  <style>
    :root{
      --vvh: 100vh; /* wird per JS (visualViewport) pr√§zise gesetzt */
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeLeft: env(safe-area-inset-left, 0px);
      --safeRight: env(safe-area-inset-right, 0px);

      --ui: rgba(15, 23, 42, 0.86);
      --uiSoft: rgba(15, 23, 42, 0.55);
      --text: #f8fafc;
      --muted: rgba(248, 250, 252, 0.72);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html, body{
      width:100%;
      height:100%;
      background:#000;
      color: var(--text);
      overflow:hidden; /* wichtig: nur Feed scrollt */
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* =========================
       FEED (TikTok Snap)
       ========================= */
    .feed{
      position: fixed;
      inset: 0;
      height: var(--vvh);
      width: 100%;
      overflow-y: scroll;
      overflow-x: hidden;

      /* CSS Snap als Basis */
      scroll-snap-type: y mandatory;
      scroll-snap-stop: always;

      /* kein ‚Äúbounce‚Äù */
      overscroll-behavior-y: contain;

      /* kein smooth */
      scroll-behavior: auto;

      /* iOS: Momentum kann dieses "langsam letzte mm" erzeugen -> wir lassen es auf auto
         und machen Snap per JS sofort */
      -webkit-overflow-scrolling: auto;

      scrollbar-width: none;
      touch-action: pan-y;
      background:#000;
    }
    .feed::-webkit-scrollbar{ display:none; }

    .reel{
      position: relative;
      height: var(--vvh);
      width: 100%;
      scroll-snap-align: start;
      scroll-snap-stop: always;
      background:#000;
      overflow:hidden;
    }

    /* Video layer */
    .reelVideo{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      background:#000;

      /* Anti-flicker: Video wird erst sichtbar wenn "warmed" */
      opacity: 0;
      transform: translateZ(0);
    }
    .reelVideo.is-ready{ opacity: 1; }

    /* leichte vignette f√ºr app-feel */
    .vignette{
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle at 50% 35%, rgba(0,0,0,0) 0%, rgba(0,0,0,0.25) 55%, rgba(0,0,0,0.62) 100%),
        linear-gradient(to bottom, rgba(0,0,0,0.52) 0%, rgba(0,0,0,0.08) 25%, rgba(0,0,0,0.08) 70%, rgba(0,0,0,0.65) 100%);
      opacity: .95;
    }

    /* =========================
       TOP BAR
       ========================= */
    .topbar{
      position:absolute;
      top: calc(10px + var(--safeTop));
      left: calc(12px + var(--safeLeft));
      right: calc(12px + var(--safeRight));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      z-index: 5;
      pointer-events:none; /* Buttons bekommen pointer-events */
    }

    .topLeft{
      display:flex;
      align-items:center;
      gap:10px;
      pointer-events:auto;
      min-width: 0;
    }

    .backBtn{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(15,23,42,0.35);
      display:grid;
      place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      backdrop-filter: blur(10px);
    }
    .backBtn svg{ width: 20px; height:20px; fill: #fff; opacity: .95; }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      padding: 8px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(15,23,42,0.30);
      backdrop-filter: blur(10px);
    }

    .brandLogo{
      width: 28px;
      height: 28px;
      border-radius: 9px;
      object-fit: contain;
      background: rgba(255,255,255,0.92);
      padding: 3px;
    }

    .brandName{
      font-weight: 750;
      font-size: 13px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 52vw;
      letter-spacing: .2px;
    }

    .topRight{
      pointer-events:auto;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .pillBtn{
      height: 44px;
      padding: 0 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(15,23,42,0.35);
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      backdrop-filter: blur(10px);
      color:#fff;
      font-weight: 700;
      font-size: 12px;
      letter-spacing:.2px;
    }
    .pillBtn svg{ width:18px; height:18px; fill:#fff; opacity:.95; }

    /* =========================
       RIGHT ACTIONS (TikTok)
       ========================= */
    .actions{
      position:absolute;
      right: calc(12px + var(--safeRight));
      bottom: calc(118px + var(--safeBottom));
      z-index: 5;
      display:flex;
      flex-direction:column;
      gap: 14px;
      align-items:center;
      pointer-events:auto;
    }

    .actionBtn{
      width: 52px;
      height: 52px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(15,23,42,0.30);
      display:grid;
      place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      backdrop-filter: blur(10px);
    }
    .actionBtn svg{ width: 22px; height:22px; fill:#fff; opacity:.95; }
    .actionCount{
      margin-top: 6px;
      font-size: 11px;
      font-weight: 800;
      color: rgba(255,255,255,0.82);
      letter-spacing:.2px;
    }

    .actionWrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      user-select:none;
    }

    .likeBtn.is-liked{
      background: rgba(255, 90, 95, 0.24);
      border-color: rgba(255, 90, 95, 0.35);
    }

    /* =========================
       BOTTOM PRODUCT CARD
       ========================= */
    .productCard{
      position:absolute;
      left: calc(12px + var(--safeLeft));
      right: calc(82px + var(--safeRight)); /* Platz f√ºr actions */
      bottom: calc(16px + var(--safeBottom));
      z-index: 5;

      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(15,23,42,0.35);
      backdrop-filter: blur(12px);
      padding: 10px 10px;
      display:flex;
      gap:10px;
      align-items:center;
      pointer-events:auto;
    }

    .productImg{
      width: 56px;
      height: 56px;
      border-radius: 14px;
      object-fit: cover;
      background: rgba(255,255,255,0.92);
    }

    .productInfo{
      flex:1;
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .productTitle{
      font-size: 13px;
      font-weight: 850;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      letter-spacing:.2px;
    }
    .productMeta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .productBtn{
      height: 38px;
      padding: 0 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      color:#fff;
      font-weight: 850;
      font-size: 12px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    .productBtn:active{ transform: scale(0.99); }

    /* =========================
       COMMENTS SHEET (Demo)
       ========================= */
    .sheetOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      opacity: 0;
      pointer-events:none;
      transition: opacity 180ms ease;
      z-index: 30;
    }
    .sheetOverlay.is-open{
      opacity: 1;
      pointer-events:auto;
    }
    .sheet{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      height: min(62vh, 520px);
      transform: translateY(105%);
      transition: transform 220ms cubic-bezier(.2,.9,.2,1);
      z-index: 31;
      background: rgba(15,23,42,0.96);
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      border: 1px solid rgba(255,255,255,0.12);
      padding: 12px 14px calc(14px + var(--safeBottom));
    }
    .sheet.is-open{ transform: translateY(0); }

    .sheetHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .sheetTitle{
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 14px;
    }
    .sheetClose{
      width: 44px;
      height: 44px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      color:#fff;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      display:grid;
      place-items:center;
    }
    .sheetClose svg{ width:18px; height:18px; fill:#fff; opacity:.95; }

    .commentsList{
      margin-top: 6px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      overflow:auto;
      height: calc(100% - 58px);
      padding-right: 4px;
    }
    .comment{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      padding: 10px 12px;
    }
    .commentUser{
      font-weight: 900;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .commentText{
      font-size: 13px;
      color: rgba(255,255,255,0.85);
      line-height: 1.35;
    }

    @media (prefers-reduced-motion: reduce){
      .sheetOverlay, .sheet{ transition:none !important; }
    }
  </style>
</head>

<body>

  <main class="feed" id="feed" aria-label="MENYRA Story Feed">

    <!-- =========================
         REEL 1
         ========================= -->
    <section class="reel" data-index="0">
      <video class="reelVideo" src="./images/tik1.mp4" playsinline webkit-playsinline muted preload="auto" loop></video>
      <div class="vignette" aria-hidden="true"></div>

      <div class="topbar">
        <div class="topLeft">
          <button class="backBtn" id="backBtn" type="button" aria-label="Back">
            <svg viewBox="0 0 24 24"><path d="M15.5 19.5L8 12l7.5-7.5 1.8 1.8L11.6 12l5.7 5.7-1.8 1.8z"/></svg>
          </button>
          <div class="brand" aria-label="Story Author">
            <img class="brandLogo" src="./images/Prince-coffe-house-logo.jpg" alt="Logo" />
            <div class="brandName">Prince Coffee House</div>
          </div>
        </div>

        <div class="topRight">
          <button class="pillBtn" id="soundBtn" type="button" aria-label="Sound toggle">
            <svg id="soundIcon" viewBox="0 0 24 24">
              <!-- muted icon -->
              <path d="M16.5 12l3.5 3.5-1.4 1.4L15.1 13.4l-3.6 3.6H8.8v-4H6v-2h2.8V7h2.7l3.6 3.6 3.5-3.5 1.4 1.4L16.5 12z"/>
            </svg>
            <span id="soundLabel">Sound</span>
          </button>
        </div>
      </div>

      <div class="actions" aria-label="Actions">
        <div class="actionWrap">
          <button class="actionBtn likeBtn" type="button" aria-label="Like">
            <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.6-9.3-8.6C.6 9 .9 5.7 3.6 4.1c2-1.1 4.4-.6 6 1 1.6-1.6 4-2.1 6-1C18.3 5.7 18.6 9 21.3 12.4 19 16.4 12 21 12 21z"/></svg>
          </button>
          <div class="actionCount likeCount">128</div>
        </div>

        <div class="actionWrap">
          <button class="actionBtn commentBtn" type="button" aria-label="Comments">
            <svg viewBox="0 0 24 24"><path d="M4 4h16v12H7l-3 3V4z"/></svg>
          </button>
          <div class="actionCount">24</div>
        </div>

        <div class="actionWrap">
          <button class="actionBtn" type="button" aria-label="Share (demo)">
            <svg viewBox="0 0 24 24"><path d="M14 9l-4 6 4-2v6h2v-6l4 2-6-8zM4 5h8V3H4a2 2 0 00-2 2v14a2 2 0 002 2h8v-2H4V5z"/></svg>
          </button>
          <div class="actionCount">‚Äî</div>
        </div>
      </div>

      <div class="productCard" aria-label="Tagged product">
        <img class="productImg" src="./images/Prince-coffe-house-offer.jpg" alt="Product" />
        <div class="productInfo">
          <div class="productTitle">Burger + Fries</div>
          <div class="productMeta">Markiert im Video ‚Ä¢ 5.90 ‚Ç¨</div>
        </div>
        <button class="productBtn" type="button">Shiko</button>
      </div>
    </section>

    <!-- =========================
         REEL 2
         ========================= -->
    <section class="reel" data-index="1">
      <video class="reelVideo" src="./images/tik2.mp4" playsinline webkit-playsinline muted preload="auto" loop></video>
      <div class="vignette" aria-hidden="true"></div>

      <div class="topbar">
        <div class="topLeft">
          <button class="backBtn" type="button" aria-label="Back (same)" data-back>
            <svg viewBox="0 0 24 24"><path d="M15.5 19.5L8 12l7.5-7.5 1.8 1.8L11.6 12l5.7 5.7-1.8 1.8z"/></svg>
          </button>
          <div class="brand">
            <img class="brandLogo" src="./images/Prince-coffe-house-logo.jpg" alt="Logo" />
            <div class="brandName">Prince Coffee House</div>
          </div>
        </div>

        <div class="topRight">
          <button class="pillBtn" type="button" aria-label="Sound toggle" data-sound>
            <svg class="soundIconClone" viewBox="0 0 24 24">
              <path d="M16.5 12l3.5 3.5-1.4 1.4L15.1 13.4l-3.6 3.6H8.8v-4H6v-2h2.8V7h2.7l3.6 3.6 3.5-3.5 1.4 1.4L16.5 12z"/>
            </svg>
            <span>Sound</span>
          </button>
        </div>
      </div>

      <div class="actions">
        <div class="actionWrap">
          <button class="actionBtn likeBtn" type="button" aria-label="Like">
            <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.6-9.3-8.6C.6 9 .9 5.7 3.6 4.1c2-1.1 4.4-.6 6 1 1.6-1.6 4-2.1 6-1C18.3 5.7 18.6 9 21.3 12.4 19 16.4 12 21 12 21z"/></svg>
          </button>
          <div class="actionCount likeCount">91</div>
        </div>

        <div class="actionWrap">
          <button class="actionBtn commentBtn" type="button" aria-label="Comments">
            <svg viewBox="0 0 24 24"><path d="M4 4h16v12H7l-3 3V4z"/></svg>
          </button>
          <div class="actionCount">11</div>
        </div>

        <div class="actionWrap">
          <button class="actionBtn" type="button" aria-label="Share (demo)">
            <svg viewBox="0 0 24 24"><path d="M14 9l-4 6 4-2v6h2v-6l4 2-6-8zM4 5h8V3H4a2 2 0 00-2 2v14a2 2 0 002 2h8v-2H4V5z"/></svg>
          </button>
          <div class="actionCount">‚Äî</div>
        </div>
      </div>

      <div class="productCard">
        <img class="productImg" src="./images/Prince-coffe-house-offer.jpg" alt="Product" />
        <div class="productInfo">
          <div class="productTitle">Prince Special</div>
          <div class="productMeta">Markiert im Video ‚Ä¢ Demo</div>
        </div>
        <button class="productBtn" type="button">Shiko</button>
      </div>
    </section>

    <!-- =========================
         REEL 3
         ========================= -->
    <section class="reel" data-index="2">
      <video class="reelVideo" src="./images/tik3.mp4" playsinline webkit-playsinline muted preload="auto" loop></video>
      <div class="vignette" aria-hidden="true"></div>

      <div class="topbar">
        <div class="topLeft">
          <button class="backBtn" type="button" aria-label="Back (same)" data-back>
            <svg viewBox="0 0 24 24"><path d="M15.5 19.5L8 12l7.5-7.5 1.8 1.8L11.6 12l5.7 5.7-1.8 1.8z"/></svg>
          </button>
          <div class="brand">
            <img class="brandLogo" src="./images/Prince-coffe-house-logo.jpg" alt="Logo" />
            <div class="brandName">Prince Coffee House</div>
          </div>
        </div>

        <div class="topRight">
          <button class="pillBtn" type="button" aria-label="Sound toggle" data-sound>
            <svg class="soundIconClone" viewBox="0 0 24 24">
              <path d="M16.5 12l3.5 3.5-1.4 1.4L15.1 13.4l-3.6 3.6H8.8v-4H6v-2h2.8V7h2.7l3.6 3.6 3.5-3.5 1.4 1.4L16.5 12z"/>
            </svg>
            <span>Sound</span>
          </button>
        </div>
      </div>

      <div class="actions">
        <div class="actionWrap">
          <button class="actionBtn likeBtn" type="button" aria-label="Like">
            <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.6-9.3-8.6C.6 9 .9 5.7 3.6 4.1c2-1.1 4.4-.6 6 1 1.6-1.6 4-2.1 6-1C18.3 5.7 18.6 9 21.3 12.4 19 16.4 12 21 12 21z"/></svg>
          </button>
          <div class="actionCount likeCount">64</div>
        </div>

        <div class="actionWrap">
          <button class="actionBtn commentBtn" type="button" aria-label="Comments">
            <svg viewBox="0 0 24 24"><path d="M4 4h16v12H7l-3 3V4z"/></svg>
          </button>
          <div class="actionCount">7</div>
        </div>

        <div class="actionWrap">
          <button class="actionBtn" type="button" aria-label="Share (demo)">
            <svg viewBox="0 0 24 24"><path d="M14 9l-4 6 4-2v6h2v-6l4 2-6-8zM4 5h8V3H4a2 2 0 00-2 2v14a2 2 0 002 2h8v-2H4V5z"/></svg>
          </button>
          <div class="actionCount">‚Äî</div>
        </div>
      </div>

      <div class="productCard">
        <img class="productImg" src="./images/Prince-coffe-house-offer.jpg" alt="Product" />
        <div class="productInfo">
          <div class="productTitle">Dessert Deal</div>
          <div class="productMeta">Markiert im Video ‚Ä¢ Demo</div>
        </div>
        <button class="productBtn" type="button">Shiko</button>
      </div>
    </section>

  </main>

  <!-- COMMENTS (Demo) -->
  <div class="sheetOverlay" id="sheetOverlay" aria-hidden="true"></div>
  <section class="sheet" id="sheet" aria-label="Comments">
    <div class="sheetHeader">
      <div class="sheetTitle">Komentet (demo)</div>
      <button class="sheetClose" id="sheetClose" type="button" aria-label="Close">
        <svg viewBox="0 0 24 24"><path d="M18.3 5.7l-1-1L12 10 6.7 4.7l-1 1L11 11l-5.3 5.3 1 1L12 12l5.3 5.3 1-1L13 11l5.3-5.3z"/></svg>
      </button>
    </div>
    <div class="commentsList">
      <div class="comment">
        <div class="commentUser">Arta</div>
        <div class="commentText">Super vibe üî•</div>
      </div>
      <div class="comment">
        <div class="commentUser">Luan</div>
        <div class="commentText">Kjo duket shum√´ mir√´ üòç</div>
      </div>
      <div class="comment">
        <div class="commentUser">Erin</div>
        <div class="commentText">A ka delivery?</div>
      </div>
    </div>
  </section>

  <script type="module">
    // =========================================================
    // STORY FEED ‚Äî Instant snap (no slow tail) + safe areas + no poster flash
    // =========================================================

    const feed = document.getElementById("feed");
    const reels = Array.from(document.querySelectorAll(".reel"));
    const videos = reels.map(r => r.querySelector(".reelVideo"));

    const sheet = document.getElementById("sheet");
    const sheetOverlay = document.getElementById("sheetOverlay");
    const sheetClose = document.getElementById("sheetClose");

    const backBtn = document.getElementById("backBtn");
    const soundBtn = document.getElementById("soundBtn");
    const soundIcon = document.getElementById("soundIcon");

    let currentIndex = 0;
    let muted = true;

    // "Instant snap" lock
    let snapping = false;
    let lastST = 0;

    const START_AT = 0.01;

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function updateVvh(){
      const vv = window.visualViewport;
      const h = vv ? vv.height : window.innerHeight;
      document.documentElement.style.setProperty("--vvh", Math.round(h) + "px");
    }
    updateVvh();
    window.addEventListener("resize", updateVvh, { passive:true });
    if (window.visualViewport){
      visualViewport.addEventListener("resize", updateVvh, { passive:true });
      visualViewport.addEventListener("scroll", updateVvh, { passive:true });
    }

    function waitOnce(el, evt){
      return new Promise((res) => el.addEventListener(evt, res, { once:true }));
    }

    async function warmVideo(v){
      if (!v || v.dataset.warmed === "1") return;

      v.playsInline = true;
      v.muted = true;

      if (v.readyState < 1) await waitOnce(v, "loadedmetadata").catch(()=>{});

      try{
        if (Number.isFinite(v.duration) && v.duration > START_AT){
          v.currentTime = START_AT;
          await waitOnce(v, "seeked").catch(()=>{});
        }
      }catch(_){}

      if (v.readyState < 2) await waitOnce(v, "loadeddata").catch(()=>{});

      // Prime decode (muted autoplay ok)
      try{
        await v.play();
        v.pause();
      }catch(_){}

      // Back to stable start frame
      try{
        if (Number.isFinite(v.duration) && v.duration > START_AT){
          v.currentTime = START_AT;
          await waitOnce(v, "seeked").catch(()=>{});
        }
      }catch(_){}

      v.dataset.warmed = "1";
      v.classList.add("is-ready"); // -> verhindert poster flash
    }

    async function warmAll(){
      await warmVideo(videos[0]);
      Promise.allSettled(videos.slice(1).map(warmVideo));
    }

    function pageHeight(){
      return feed.clientHeight || window.innerHeight || 1;
    }

    function goToIndex(idx){
      const h = pageHeight();
      const target = clamp(idx, 0, reels.length - 1);
      snapping = true;
      feed.scrollTop = target * h;     // sofort, kein easing
      currentIndex = target;

      // lock kurz halten, damit wir nicht im Loop landen
      window.setTimeout(() => { snapping = false; lastST = feed.scrollTop; }, 70);
    }

    function setMutedState(isMuted){
      muted = isMuted;

      // Icon swap (nur das erste, die anderen sind clones)
      if (!muted){
        soundIcon.innerHTML =
          '<path d="M3 10v4h3l4 4V6L6 10H3z"/>' +
          '<path d="M16.5 12a4.5 4.5 0 01-2.1 3.8l-1-1.7a2.5 2.5 0 000-4.2l1-1.7A4.5 4.5 0 0116.5 12z"/>' +
          '<path d="M14.3 3.7l-1 1.7A7.5 7.5 0 0117.5 12a7.5 7.5 0 01-4.2 6.6l1 1.7A9.5 9.5 0 0019.5 12a9.5 9.5 0 00-5.2-8.3z"/>';
      } else {
        soundIcon.innerHTML =
          '<path d="M16.5 12l3.5 3.5-1.4 1.4L15.1 13.4l-3.6 3.6H8.8v-4H6v-2h2.8V7h2.7l3.6 3.6 3.5-3.5 1.4 1.4L16.5 12z"/>';
      }

      // Active video
      const v = videos[currentIndex];
      if (!v) return;

      videos.forEach((vv, i) => { if (i !== currentIndex) vv.muted = true; });
      v.muted = muted ? true : false;
      v.volume = 1;
      v.play().catch(()=>{});
    }

    async function activate(idx){
      currentIndex = clamp(idx, 0, reels.length - 1);

      const v = videos[currentIndex];
      if (v) await warmVideo(v);

      videos.forEach((vv, i) => {
        if (!vv) return;
        if (i === currentIndex){
          vv.muted = muted ? true : false;
          vv.volume = 1;
          vv.play().catch(()=>{});
        } else {
          vv.pause();
          vv.muted = true;
          try{
            if (vv.dataset.warmed === "1" && Number.isFinite(vv.duration) && vv.duration > START_AT){
              vv.currentTime = START_AT;
            }
          }catch(_){}
        }
      });

      // warm neighbors
      if (videos[currentIndex - 1]) warmVideo(videos[currentIndex - 1]);
      if (videos[currentIndex + 1]) warmVideo(videos[currentIndex + 1]);
    }

    // IntersectionObserver: wer ist aktiv?
    const io = new IntersectionObserver((entries) => {
      if (snapping) return;
      let best = null;
      for (const e of entries){
        if (!best || e.intersectionRatio > best.intersectionRatio) best = e;
      }
      if (!best || !best.isIntersecting) return;
      const idx = parseInt(best.target.dataset.index || "0", 10) || 0;
      if (idx !== currentIndex) activate(idx);
    }, { root: feed, threshold: [0.55, 0.75] });

    reels.forEach(r => io.observe(r));

    // =========================================================
    // IMPORTANT: INSTANT SNAP (kein "langsam letzte mm")
    // - sobald User scrollt, springen wir sofort zur n√§chsten/prev Seite.
    // =========================================================
    feed.addEventListener("scroll", () => {
      if (snapping) return;

      const st = feed.scrollTop;
      const delta = st - lastST;

      // kleine jitter ignorieren
      if (Math.abs(delta) < 6) return;

      // Richtung -> sofortiger Page Jump
      if (delta > 0) goToIndex(currentIndex + 1);
      else goToIndex(currentIndex - 1);
    }, { passive:true });

    // Click delegation: like / comments / sound clones / back clones
    document.addEventListener("click", (e) => {
      // Back buttons
      if (e.target.closest("#backBtn") || e.target.closest("[data-back]")){
        e.preventDefault();
        window.location.href = "./karte-demo.html";
        return;
      }

      // Sound button + clones
      if (e.target.closest("#soundBtn") || e.target.closest("[data-sound]")){
        e.preventDefault();
        setMutedState(!muted);
        return;
      }

      // Like
      const like = e.target.closest(".likeBtn");
      if (like){
        const reel = like.closest(".reel");
        const countEl = reel?.querySelector(".likeCount");
        const cur = parseInt((countEl?.textContent || "0").trim(), 10) || 0;
        const liked = like.classList.toggle("is-liked");
        if (countEl) countEl.textContent = String(liked ? cur + 1 : Math.max(0, cur - 1));
        return;
      }

      // Comments
      if (e.target.closest(".commentBtn")){
        e.preventDefault();
        openSheet();
        return;
      }
    }, { passive:false });

    function openSheet(){
      sheetOverlay.classList.add("is-open");
      sheet.classList.add("is-open");
      sheetOverlay.setAttribute("aria-hidden","false");
    }
    function closeSheet(){
      sheetOverlay.classList.remove("is-open");
      sheet.classList.remove("is-open");
      sheetOverlay.setAttribute("aria-hidden","true");
    }
    sheetOverlay.addEventListener("click", closeSheet, { passive:true });
    sheetClose.addEventListener("click", closeSheet, { passive:true });

    // ESC closes
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeSheet();
    });

    // Start: warm + exakt auf 0 + autoplay
    window.addEventListener("pageshow", async () => {
      updateVvh();
      await warmAll();
      goToIndex(0);
      await activate(0);
      setMutedState(true);
      lastST = feed.scrollTop;
    }, { passive:true });
  </script>
</body>
</html>
