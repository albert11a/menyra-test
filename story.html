<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>MENYRA ‚Äì Story</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />

  <!-- Preload: hilft dem 1. Reel sofort (wenn Pfad stimmt) -->
  <link rel="preload" as="video" href="./images/tik1.mp4" type="video/mp4">
  <link rel="preload" as="video" href="./image/tik1.mp4" type="video/mp4">

  <style>
    :root{
      --vvh: 100vh;
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeLeft: env(safe-area-inset-left, 0px);
      --safeRight: env(safe-area-inset-right, 0px);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html, body{
      width:100%;
      height:100%;
      background:#000;
      overflow:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#fff;
    }

    #app{
      position: fixed;
      inset: 0;
      width:100%;
      height: var(--vvh);
      background:#000;
      overflow:hidden;
      touch-action: pan-x; /* pan-y handled by pager */
    }

    #stage{
      position:absolute;
      inset:0;
      width:100%;
      transform: translate3d(0,0,0);
      will-change: transform;
    }

    .reel{
      position:absolute;
      left:0; right:0; top:0;
      width:100%;
      height: var(--vvh);
      background:#000;
      overflow:hidden;
      transform: translate3d(0,0,0);
    }

    /* Video */
    .reelVideo{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      background:#000;
      transform: translateZ(0);
    }

    /* Frame hold (fix gegen black flash + preview mismatch)
       - erst shimmer
       - dann echtes Frame aus Video
       - beim playing fade-out */
    .frameHold{
      position:absolute;
      inset:0;
      z-index: 2;
      background: #000;
      transform: translateZ(0);
      opacity: 1;
      pointer-events:none;
      transition: opacity 160ms ease;
    }
    .frameHold.is-hidden{ opacity: 0; }

    .frameHold::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 40% 30%, rgba(255,255,255,0.06), transparent 55%),
        linear-gradient(120deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.06) 40%, rgba(255,255,255,0.03) 70%),
        #000;
      opacity: .9;
      animation: shimmer 1.0s linear infinite;
    }
    .frameHold.has-frame::before{ display:none; }

    @keyframes shimmer{
      0%{ transform: translateX(-8%); opacity:.75; }
      50%{ transform: translateX(0%); opacity:.95; }
      100%{ transform: translateX(8%); opacity:.75; }
    }

    .vignette{
      position:absolute;
      inset:0;
      z-index: 3;
      pointer-events:none;
      background:
        radial-gradient(circle at 50% 35%, rgba(0,0,0,0) 0%, rgba(0,0,0,0.25) 55%, rgba(0,0,0,0.62) 100%),
        linear-gradient(to bottom, rgba(0,0,0,0.55) 0%, rgba(0,0,0,0.08) 30%, rgba(0,0,0,0.08) 72%, rgba(0,0,0,0.68) 100%);
      opacity:.95;
    }

    /* Top UI */
    .topbar{
      position:absolute;
      top: calc(10px + var(--safeTop));
      left: calc(12px + var(--safeLeft));
      right: calc(12px + var(--safeRight));
      z-index: 10;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .topLeft, .topRight{
      pointer-events:auto;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    .backBtn{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(15,23,42,0.35);
      backdrop-filter: blur(10px);
      display:grid; place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .backBtn svg{ width:20px; height:20px; fill:#fff; opacity:.95; }

    .brand{
      display:flex; align-items:center; gap:10px;
      padding:8px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(15,23,42,0.30);
      backdrop-filter: blur(10px);
      min-width:0;
    }
    .brandLogo{
      width:28px; height:28px;
      border-radius:9px;
      object-fit: contain;
      background: rgba(255,255,255,0.92);
      padding:3px;
    }
    .brandName{
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 54vw;
      letter-spacing:.2px;
    }

    .pillBtn{
      height:44px;
      padding:0 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(15,23,42,0.35);
      backdrop-filter: blur(10px);
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      font-weight:900;
      font-size:12px;
      color:#fff;
      letter-spacing:.2px;
    }
    .pillBtn svg{ width:18px; height:18px; fill:#fff; opacity:.95; }

    /* Right actions */
    .actions{
      position:absolute;
      right: calc(12px + var(--safeRight));
      bottom: calc(118px + var(--safeBottom));
      z-index: 10;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      pointer-events:auto;
      user-select:none;
    }
    .actionWrap{ display:flex; flex-direction:column; align-items:center; gap:6px; }
    .actionBtn{
      width:52px; height:52px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(15,23,42,0.30);
      backdrop-filter: blur(10px);
      display:grid; place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .actionBtn svg{ width:22px; height:22px; fill:#fff; opacity:.95; }
    .actionCount{
      font-size:11px;
      font-weight:950;
      color: rgba(255,255,255,0.82);
      letter-spacing:.2px;
    }
    .likeBtn.is-liked{
      background: rgba(255,90,95,0.24);
      border-color: rgba(255,90,95,0.38);
    }

    /* Product card bottom */
    .productCard{
      position:absolute;
      left: calc(12px + var(--safeLeft));
      right: calc(82px + var(--safeRight));
      bottom: calc(16px + var(--safeBottom));
      z-index: 10;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(15,23,42,0.35);
      backdrop-filter: blur(12px);
      pointer-events:auto;
      min-width:0;
    }
    .productImg{
      width:56px; height:56px;
      border-radius:14px;
      object-fit: cover;
      background: rgba(255,255,255,0.92);
      flex:0 0 auto;
    }
    .productInfo{ flex:1; min-width:0; display:flex; flex-direction:column; gap:2px; }
    .productTitle{
      font-size:13px;
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      letter-spacing:.2px;
    }
    .productMeta{
      font-size:12px;
      color: rgba(255,255,255,0.72);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .productBtn{
      height:38px;
      padding:0 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      color:#fff;
      font-weight:950;
      font-size:12px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
      flex:0 0 auto;
    }

    /* Comments demo */
    .sheetOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      opacity: 0;
      pointer-events:none;
      transition: opacity 180ms ease;
      z-index: 50;
    }
    .sheetOverlay.is-open{ opacity: 1; pointer-events:auto; }

    .sheet{
      position: fixed;
      left:0; right:0;
      bottom:0;
      height: min(62vh, 520px);
      transform: translateY(105%);
      transition: transform 220ms cubic-bezier(.2,.9,.2,1);
      z-index: 51;
      background: rgba(15,23,42,0.96);
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      border: 1px solid rgba(255,255,255,0.12);
      padding: 12px 14px calc(14px + var(--safeBottom));
    }
    .sheet.is-open{ transform: translateY(0); }

    .sheetHeader{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .sheetTitle{ font-weight:950; font-size:14px; letter-spacing:.2px; }
    .sheetClose{
      width:44px; height:44px;
      border-radius:16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      display:grid; place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .sheetClose svg{ width:18px; height:18px; fill:#fff; opacity:.95; }

    .commentsList{
      height: calc(100% - 58px);
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-right: 4px;
    }
    .comment{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      padding: 10px 12px;
    }
    .commentUser{ font-weight:950; font-size:12px; margin-bottom:4px; }
    .commentText{ font-size:13px; color: rgba(255,255,255,0.86); line-height: 1.35; }
  </style>
</head>

<body>
  <div id="app" aria-label="MENYRA Story App">
    <div id="stage">

      <!-- REEL 1 -->
      <section class="reel" data-index="0">
        <video class="reelVideo" data-file="tik1.mp4" playsinline webkit-playsinline muted preload="auto" loop></video>
        <div class="frameHold" aria-hidden="true"></div>
        <div class="vignette" aria-hidden="true"></div>

        <div class="topbar">
          <div class="topLeft">
            <button class="backBtn" id="backBtn" type="button" aria-label="Back">
              <svg viewBox="0 0 24 24"><path d="M15.5 19.5L8 12l7.5-7.5 1.8 1.8L11.6 12l5.7 5.7-1.8 1.8z"/></svg>
            </button>
            <div class="brand">
              <img class="brandLogo" src="./images/Prince-coffe-house-logo.jpg" alt="Logo" />
              <div class="brandName">Prince Coffee House</div>
            </div>
          </div>

          <div class="topRight">
            <button class="pillBtn" id="soundBtn" type="button" aria-label="Sound toggle">
              <svg id="soundIcon" viewBox="0 0 24 24">
                <path d="M16.5 12l3.5 3.5-1.4 1.4L15.1 13.4l-3.6 3.6H8.8v-4H6v-2h2.8V7h2.7l3.6 3.6 3.5-3.5 1.4 1.4L16.5 12z"/>
              </svg>
              <span>Sound</span>
            </button>
          </div>
        </div>

        <div class="actions">
          <div class="actionWrap">
            <button class="actionBtn likeBtn" type="button" aria-label="Like">
              <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.6-9.3-8.6C.6 9 .9 5.7 3.6 4.1c2-1.1 4.4-.6 6 1 1.6-1.6 4-2.1 6-1C18.3 5.7 18.6 9 21.3 12.4 19 16.4 12 21 12 21z"/></svg>
            </button>
            <div class="actionCount likeCount">128</div>
          </div>

          <div class="actionWrap">
            <button class="actionBtn commentBtn" type="button" aria-label="Comments">
              <svg viewBox="0 0 24 24"><path d="M4 4h16v12H7l-3 3V4z"/></svg>
            </button>
            <div class="actionCount">24</div>
          </div>
        </div>

        <div class="productCard">
          <img class="productImg" src="./images/Prince-coffe-house-offer.jpg" alt="Product" />
          <div class="productInfo">
            <div class="productTitle">Burger + Fries</div>
            <div class="productMeta">Markiert im Video ‚Ä¢ 5.90 ‚Ç¨</div>
          </div>
          <button class="productBtn" type="button">Shiko</button>
        </div>
      </section>

      <!-- REEL 2 -->
      <section class="reel" data-index="1">
        <video class="reelVideo" data-file="tik2.mp4" playsinline webkit-playsinline muted preload="auto" loop></video>
        <div class="frameHold" aria-hidden="true"></div>
        <div class="vignette" aria-hidden="true"></div>

        <div class="topbar">
          <div class="topLeft">
            <button class="backBtn" type="button" aria-label="Back" data-back>
              <svg viewBox="0 0 24 24"><path d="M15.5 19.5L8 12l7.5-7.5 1.8 1.8L11.6 12l5.7 5.7-1.8 1.8z"/></svg>
            </button>
            <div class="brand">
              <img class="brandLogo" src="./images/Prince-coffe-house-logo.jpg" alt="Logo" />
              <div class="brandName">Prince Coffee House</div>
            </div>
          </div>

          <div class="topRight">
            <button class="pillBtn" type="button" aria-label="Sound toggle" data-sound>
              <svg viewBox="0 0 24 24">
                <path d="M16.5 12l3.5 3.5-1.4 1.4L15.1 13.4l-3.6 3.6H8.8v-4H6v-2h2.8V7h2.7l3.6 3.6 3.5-3.5 1.4 1.4L16.5 12z"/>
              </svg>
              <span>Sound</span>
            </button>
          </div>
        </div>

        <div class="actions">
          <div class="actionWrap">
            <button class="actionBtn likeBtn" type="button" aria-label="Like">
              <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.6-9.3-8.6C.6 9 .9 5.7 3.6 4.1c2-1.1 4.4-.6 6 1 1.6-1.6 4-2.1 6-1C18.3 5.7 18.6 9 21.3 12.4 19 16.4 12 21 12 21z"/></svg>
            </button>
            <div class="actionCount likeCount">91</div>
          </div>

          <div class="actionWrap">
            <button class="actionBtn commentBtn" type="button" aria-label="Comments">
              <svg viewBox="0 0 24 24"><path d="M4 4h16v12H7l-3 3V4z"/></svg>
            </button>
            <div class="actionCount">11</div>
          </div>
        </div>

        <div class="productCard">
          <img class="productImg" src="./images/Prince-coffe-house-offer.jpg" alt="Product" />
          <div class="productInfo">
            <div class="productTitle">Prince Special</div>
            <div class="productMeta">Markiert im Video ‚Ä¢ Demo</div>
          </div>
          <button class="productBtn" type="button">Shiko</button>
        </div>
      </section>

      <!-- REEL 3 -->
      <section class="reel" data-index="2">
        <video class="reelVideo" data-file="tik3.mp4" playsinline webkit-playsinline muted preload="auto" loop></video>
        <div class="frameHold" aria-hidden="true"></div>
        <div class="vignette" aria-hidden="true"></div>

        <div class="topbar">
          <div class="topLeft">
            <button class="backBtn" type="button" aria-label="Back" data-back>
              <svg viewBox="0 0 24 24"><path d="M15.5 19.5L8 12l7.5-7.5 1.8 1.8L11.6 12l5.7 5.7-1.8 1.8z"/></svg>
            </button>
            <div class="brand">
              <img class="brandLogo" src="./images/Prince-coffe-house-logo.jpg" alt="Logo" />
              <div class="brandName">Prince Coffee House</div>
            </div>
          </div>

          <div class="topRight">
            <button class="pillBtn" type="button" aria-label="Sound toggle" data-sound>
              <svg viewBox="0 0 24 24">
                <path d="M16.5 12l3.5 3.5-1.4 1.4L15.1 13.4l-3.6 3.6H8.8v-4H6v-2h2.8V7h2.7l3.6 3.6 3.5-3.5 1.4 1.4L16.5 12z"/>
              </svg>
              <span>Sound</span>
            </button>
          </div>
        </div>

        <div class="actions">
          <div class="actionWrap">
            <button class="actionBtn likeBtn" type="button" aria-label="Like">
              <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.6-9.3-8.6C.6 9 .9 5.7 3.6 4.1c2-1.1 4.4-.6 6 1 1.6-1.6 4-2.1 6-1C18.3 5.7 18.6 9 21.3 12.4 19 16.4 12 21 12 21z"/></svg>
            </button>
            <div class="actionCount likeCount">64</div>
          </div>

          <div class="actionWrap">
            <button class="actionBtn commentBtn" type="button" aria-label="Comments">
              <svg viewBox="0 0 24 24"><path d="M4 4h16v12H7l-3 3V4z"/></svg>
            </button>
            <div class="actionCount">7</div>
          </div>
        </div>

        <div class="productCard">
          <img class="productImg" src="./images/Prince-coffe-house-offer.jpg" alt="Product" />
          <div class="productInfo">
            <div class="productTitle">Dessert Deal</div>
            <div class="productMeta">Markiert im Video ‚Ä¢ Demo</div>
          </div>
          <button class="productBtn" type="button">Shiko</button>
        </div>
      </section>

    </div>
  </div>

  <!-- Comments (demo) -->
  <div class="sheetOverlay" id="sheetOverlay" aria-hidden="true"></div>
  <section class="sheet" id="sheet" aria-label="Comments">
    <div class="sheetHeader">
      <div class="sheetTitle">Komentet (demo)</div>
      <button class="sheetClose" id="sheetClose" type="button" aria-label="Close">
        <svg viewBox="0 0 24 24"><path d="M18.3 5.7l-1-1L12 10 6.7 4.7l-1 1L11 11l-5.3 5.3 1 1L12 12l5.3 5.3 1-1L13 11l5.3-5.3z"/></svg>
      </button>
    </div>
    <div class="commentsList">
      <div class="comment"><div class="commentUser">Arta</div><div class="commentText">Super vibe üî•</div></div>
      <div class="comment"><div class="commentUser">Luan</div><div class="commentText">Kjo duket shum√´ mir√´ üòç</div></div>
      <div class="comment"><div class="commentUser">Erin</div><div class="commentText">A ka delivery?</div></div>
    </div>
  </section>

  <script type="module">
    // =========================================================
    // MENYRA STORY ‚Äî TikTok Pager + FrameHold (kein black flash)
    // =========================================================

    const app   = document.getElementById("app");
    const stage = document.getElementById("stage");
    const reels = Array.from(document.querySelectorAll(".reel"));
    const videos = reels.map(r => r.querySelector(".reelVideo"));
    const holds  = reels.map(r => r.querySelector(".frameHold"));

    const backBtn   = document.getElementById("backBtn");
    const soundBtn  = document.getElementById("soundBtn");
    const soundIcon = document.getElementById("soundIcon");

    const sheet = document.getElementById("sheet");
    const sheetOverlay = document.getElementById("sheetOverlay");
    const sheetClose = document.getElementById("sheetClose");

    let idx = 0;
    let muted = true;

    // drag state
    let dragging = false;
    let startY = 0;
    let startX = 0;
    let dy = 0;
    let lastY = 0;
    let lastT = 0;
    let vY = 0;
    let lockAxis = null;
    let animating = false;

    // wheel
    let wheelAcc = 0;
    let wheelTimer = null;

    function updateVvh(){
      const vv = window.visualViewport;
      const h = vv ? vv.height : window.innerHeight;
      document.documentElement.style.setProperty("--vvh", Math.round(h) + "px");
    }
    function vh(){ return app.clientHeight || window.innerHeight || 1; }
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function setStage(offset = 0, animate = false){
      stage.style.transition = animate ? "transform 260ms cubic-bezier(.2,.9,.2,1)" : "none";
      const y = (-idx * vh()) + offset;
      stage.style.transform = `translate3d(0, ${y}px, 0)`;
    }

    function placeReels(){
      stage.style.height = `calc(var(--vvh) * ${reels.length})`;
      reels.forEach((r, i) => {
        r.style.transform = `translate3d(0, ${i * vh()}px, 0)`;
      });
      setStage(0, false);
    }

    function setVideoSrcWithFallback(videoEl){
      const file = videoEl.dataset.file;
      if (!file) return;

      const primary  = `./images/${file}`;
      const fallback = `./image/${file}`;

      if (!videoEl.src) videoEl.src = primary;

      const onErr = () => {
        videoEl.removeEventListener("error", onErr);
        videoEl.src = fallback;
        try{ videoEl.load(); }catch(_){}
      };
      videoEl.addEventListener("error", onErr, { once:true });
    }

    function warmLoad(v){
      if (!v) return;
      try{ v.preload = "auto"; v.load(); }catch(_){}
    }

    // --- FrameHold: capture real first frame to prevent mismatch
    async function captureFrame(videoEl, holdEl){
      if (!videoEl || !holdEl) return;
      if (holdEl.dataset.hasFrame === "1") return;

      // Wait until we have some decoded frame
      if (videoEl.readyState < 2){
        await new Promise((res) => {
          const t = setTimeout(res, 1200); // never block forever
          videoEl.addEventListener("loadeddata", () => { clearTimeout(t); res(); }, { once:true });
        });
      }

      // Try requestVideoFrameCallback (best)
      if (typeof videoEl.requestVideoFrameCallback === "function"){
        await new Promise((res) => videoEl.requestVideoFrameCallback(() => res()));
      }

      // Draw to canvas -> set as hold background
      try{
        const w = Math.max(2, videoEl.videoWidth || 0);
        const h = Math.max(2, videoEl.videoHeight || 0);
        if (w > 2 && h > 2){
          const c = document.createElement("canvas");
          c.width = w;
          c.height = h;
          const ctx = c.getContext("2d", { alpha:false });
          ctx.drawImage(videoEl, 0, 0, w, h);
          const url = c.toDataURL("image/jpeg", 0.72);
          holdEl.style.backgroundImage = `url("${url}")`;
          holdEl.style.backgroundSize = "cover";
          holdEl.style.backgroundPosition = "center";
          holdEl.classList.add("has-frame");
          holdEl.dataset.hasFrame = "1";
        }
      }catch(_){}
    }

    function showHold(i){
      const h = holds[i];
      if (!h) return;
      h.classList.remove("is-hidden");
    }
    function hideHold(i){
      const h = holds[i];
      if (!h) return;
      h.classList.add("is-hidden");
    }

    function iconMuted(){
      soundIcon.innerHTML = '<path d="M16.5 12l3.5 3.5-1.4 1.4L15.1 13.4l-3.6 3.6H8.8v-4H6v-2h2.8V7h2.7l3.6 3.6 3.5-3.5 1.4 1.4L16.5 12z"/>';
    }
    function iconSound(){
      soundIcon.innerHTML =
        '<path d="M3 10v4h3l4 4V6L6 10H3z"/>' +
        '<path d="M16.5 12a4.5 4.5 0 01-2.1 3.8l-1-1.7a2.5 2.5 0 000-4.2l1-1.7A4.5 4.5 0 0116.5 12z"/>' +
        '<path d="M14.3 3.7l-1 1.7A7.5 7.5 0 0117.5 12a7.5 7.5 0 01-4.2 6.6l1 1.7A9.5 9.5 0 0019.5 12a9.5 9.5 0 00-5.2-8.3z"/>';
    }

    function setMuted(nextMuted){
      muted = nextMuted;
      if (muted) iconMuted(); else iconSound();
      const v = videos[idx];
      if (v){
        v.muted = muted ? true : false;
        v.play().catch(()=>{});
      }
    }

    async function prepVideo(i){
      const v = videos[i];
      const h = holds[i];
      if (!v || !h) return;

      setVideoSrcWithFallback(v);

      v.muted = true;        // autoplay safe
      v.playsInline = true;
      v.preload = "auto";

      // show hold while preparing
      showHold(i);

      // force load earlier
      warmLoad(v);

      // Seek minimal once, to stabilize first frame (avoids preview mismatch)
      // Important: only once per video
      if (!v.dataset.seekingDone){
        await new Promise((res) => {
          const done = () => res();
          if (v.readyState >= 1) return done();
          v.addEventListener("loadedmetadata", done, { once:true });
          setTimeout(done, 900);
        });

        try{
          // 0 sometimes ignored, so 0.001
          v.currentTime = 0.001;
          await new Promise((res) => {
            const t = setTimeout(res, 700);
            v.addEventListener("seeked", () => { clearTimeout(t); res(); }, { once:true });
          });
        }catch(_){}
        v.dataset.seekingDone = "1";
      }

      // Capture real frame into hold background
      await captureFrame(v, h);
    }

    async function playActive(){
      // stop others
      videos.forEach((vv, i) => {
        if (!vv) return;
        if (i !== idx){
          vv.pause();
          vv.muted = true;
          showHold(i); // if user comes back, hold is ready
        }
      });

      const v = videos[idx];
      if (!v) return;

      // Prepare active + neighbors (warm + frame capture)
      await prepVideo(idx);
      if (videos[idx + 1]) prepVideo(idx + 1);
      if (videos[idx - 1]) prepVideo(idx - 1);

      // Play
      v.muted = muted ? true : false;

      // Events: waiting => show hold, playing => hide hold (super smooth)
      const onWaiting = () => showHold(idx);
      const onPlaying = () => hideHold(idx);
      v.addEventListener("waiting", onWaiting);
      v.addEventListener("playing", onPlaying);

      // try play
      try{
        const p = v.play();
        if (p && typeof p.then === "function") await p;
      }catch(_){
        // if unmuted autoplay blocked, it will still show hold; user can toggle sound later
      }

      // if already playing quickly, hide hold
      if (!v.paused) hideHold(idx);

      // cleanup handlers (avoid duplicates)
      setTimeout(() => {
        v.removeEventListener("waiting", onWaiting);
        v.removeEventListener("playing", onPlaying);
      }, 1200);
    }

    function go(nextIdx){
      if (animating) return;
      const target = clamp(nextIdx, 0, reels.length - 1);

      if (target === idx){
        animating = true;
        setStage(0, true);
        setTimeout(() => { animating = false; setStage(0, false); }, 260);
        return;
      }

      animating = true;
      idx = target;

      setStage(0, true);
      setTimeout(async () => {
        animating = false;
        setStage(0, false);
        await playActive();
      }, 260);
    }

    // Comments
    function openSheet(){
      sheetOverlay.classList.add("is-open");
      sheet.classList.add("is-open");
      sheetOverlay.setAttribute("aria-hidden","false");
    }
    function closeSheet(){
      sheetOverlay.classList.remove("is-open");
      sheet.classList.remove("is-open");
      sheetOverlay.setAttribute("aria-hidden","true");
    }
    sheetOverlay.addEventListener("click", closeSheet, { passive:true });
    sheetClose.addEventListener("click", closeSheet, { passive:true });

    // UI click
    document.addEventListener("click", (e) => {
      if (e.target.closest("#backBtn") || e.target.closest("[data-back]")){
        e.preventDefault();
        window.location.href = "./karte-demo.html";
        return;
      }
      if (e.target.closest("#soundBtn") || e.target.closest("[data-sound]")){
        e.preventDefault();
        setMuted(!muted);
        return;
      }
      const like = e.target.closest(".likeBtn");
      if (like){
        const reel = like.closest(".reel");
        const countEl = reel?.querySelector(".likeCount");
        const cur = parseInt((countEl?.textContent || "0").trim(), 10) || 0;
        const liked = like.classList.toggle("is-liked");
        if (countEl) countEl.textContent = String(liked ? cur + 1 : Math.max(0, cur - 1));
        return;
      }
      if (e.target.closest(".commentBtn")){
        e.preventDefault();
        openSheet();
        return;
      }
    }, { passive:false });

    // Swipe pager
    function isInteractiveTarget(t){
      return !!t?.closest("button, a, input, textarea, select, .productCard, .actions, .topbar, .sheet, .sheetOverlay");
    }

    app.addEventListener("pointerdown", (e) => {
      if (isInteractiveTarget(e.target)) return;
      if (animating) return;

      dragging = true;
      lockAxis = null;
      dy = 0;

      startY = e.clientY;
      startX = e.clientX;
      lastY = e.clientY;
      lastT = performance.now();
      vY = 0;

      try{ app.setPointerCapture(e.pointerId); }catch(_){}
      stage.style.transition = "none";
    }, { passive:true });

    app.addEventListener("pointermove", (e) => {
      if (!dragging) return;

      const curY = e.clientY;
      const curX = e.clientX;
      const deltaY = curY - startY;
      const deltaX = curX - startX;

      if (!lockAxis){
        if (Math.abs(deltaY) + Math.abs(deltaX) < 10) return;
        lockAxis = Math.abs(deltaY) >= Math.abs(deltaX) ? "y" : "x";
      }
      if (lockAxis !== "y") return;

      const now = performance.now();
      const dt = Math.max(1, now - lastT);
      vY = (curY - lastY) / dt;
      lastY = curY;
      lastT = now;

      let offset = deltaY;
      if (idx === 0 && offset > 0) offset *= 0.32;
      if (idx === reels.length - 1 && offset < 0) offset *= 0.32;

      dy = offset;
      setStage(dy, false);
    }, { passive:true });

    app.addEventListener("pointerup", () => {
      if (!dragging) return;
      dragging = false;

      if (lockAxis !== "y"){
        animating = true;
        setStage(0, true);
        setTimeout(() => { animating = false; setStage(0, false); }, 260);
        return;
      }

      const H = vh();
      const dist = dy;
      const absDist = Math.abs(dist);
      const speed = vY;

      const THRESH_DIST = Math.max(80, H * 0.18);
      const THRESH_VEL  = 0.75;

      if (absDist > THRESH_DIST || Math.abs(speed) > THRESH_VEL){
        if (dist < 0) go(idx + 1);
        else go(idx - 1);
      } else {
        animating = true;
        setStage(0, true);
        setTimeout(() => { animating = false; setStage(0, false); }, 260);
      }
    }, { passive:true });

    app.addEventListener("pointercancel", () => {
      if (!dragging) return;
      dragging = false;
      animating = true;
      setStage(0, true);
      setTimeout(() => { animating = false; setStage(0, false); }, 260);
    }, { passive:true });

    // Wheel (desktop)
    app.addEventListener("wheel", (e) => {
      if (animating || dragging) return;
      if (sheetOverlay.classList.contains("is-open")) return;

      e.preventDefault();

      wheelAcc += e.deltaY;
      clearTimeout(wheelTimer);
      wheelTimer = setTimeout(() => {
        const a = wheelAcc;
        wheelAcc = 0;
        if (Math.abs(a) < 60) return;
        if (a > 0) go(idx + 1);
        else go(idx - 1);
      }, 90);
    }, { passive:false });

    // Init
    function init(){
      updateVvh();
      placeReels();

      videos.forEach((v, i) => {
        v.muted = true;
        v.preload = "auto";
        setVideoSrcWithFallback(v);
        showHold(i); // hold visible until playing stable
      });

      setMuted(true);

      // Warm first + neighbor hard
      warmLoad(videos[0]);
      warmLoad(videos[1]);

      playActive();
    }

    updateVvh();
    window.addEventListener("resize", () => {
      updateVvh();
      placeReels();
    }, { passive:true });

    if (window.visualViewport){
      visualViewport.addEventListener("resize", () => {
        updateVvh();
        placeReels();
      }, { passive:true });
      visualViewport.addEventListener("scroll", () => {
        updateVvh();
        placeReels();
      }, { passive:true });
    }

    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", init, { once:true });
    } else {
      init();
    }
  </script>
</body>
</html>
