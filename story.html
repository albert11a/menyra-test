<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>MENYRA â€“ Story</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />

  <!-- (Optional, aber hilft) Preload: schneller Start -->
  <link rel="preload" as="image" href="./images/Prince-coffe-house-logo.jpg" />
  <link rel="preload" as="image" href="./images/Prince-coffe-house-offer.jpg" />
  <link rel="preload" as="video" href="./images/tik1.mp4" type="video/mp4" />
  <link rel="preload" as="video" href="./images/tik2.mp4" type="video/mp4" />
  <link rel="preload" as="video" href="./images/tik3.mp4" type="video/mp4" />

  <style>
    :root{
      --app-h: 100dvh; /* wird per JS mit visualViewport perfekt gesetzt */
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bot: env(safe-area-inset-bottom, 0px);
      --topbar-h: 56px;

      --txt: rgba(255,255,255,0.92);
      --sub: rgba(255,255,255,0.68);
      --chip: rgba(255,255,255,0.12);
      --chip2: rgba(255,255,255,0.18);
      --line: rgba(255,255,255,0.16);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html, body{ height:100%; background:#000; color:#fff; }
    body{
      overflow:hidden; /* wichtig: keine Body-Scroll */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }
    button{ font:inherit; color:inherit; }
    img{ display:block; max-width:100%; }

    /* App fixed â€“ Safe area korrekt */
    .app{
      position:fixed;
      inset:0;
      height: var(--app-h);
      background:#000;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bot);
      display:flex;
      flex-direction:column;
    }

    /* Topbar */
    .topbar{
      height: var(--topbar-h);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      z-index:20;
      position:relative;
    }
    .topbar::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,0.70), rgba(0,0,0,0.0));
      pointer-events:none;
      z-index:-1;
    }

    .iconBtn{
      width:40px; height:40px;
      border-radius:14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      display:grid; place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .iconBtn:active{ transform: scale(0.98); }

    .logo{
      width:28px; height:28px;
      border-radius:8px;
      object-fit:contain;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
    }

    .titleWrap{
      display:flex;
      flex-direction:column;
      line-height:1.05;
      min-width:0;
    }
    .title{
      font-weight:800;
      font-size:14px;
      letter-spacing:0.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: var(--txt);
    }
    .subtitle{
      font-size:12px;
      color: var(--sub);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .spacer{ flex:1; }

    /* Feed */
    .feed{
      height: calc(var(--app-h) - var(--safe-top) - var(--safe-bot) - var(--topbar-h));
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: y mandatory;
      scroll-behavior:auto;
      overscroll-behavior-y: contain;
      background:#000;
    }
    .feed::-webkit-scrollbar{ display:none; }

    .reel{
      height: calc(var(--app-h) - var(--safe-top) - var(--safe-bot) - var(--topbar-h));
      scroll-snap-align: start;
      scroll-snap-stop: always;
      position:relative;
      background:#000;
      isolation:isolate;
    }

    /* Video */
    .reel video{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      background:#000;
    }

    /* Placeholder bis erste Frame wirklich gerendert ist (kein Poster-Bug) */
    .placeholder{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      background:
        radial-gradient(900px 480px at 20% 10%, rgba(255,255,255,0.08), transparent 60%),
        radial-gradient(900px 480px at 80% 30%, rgba(255,255,255,0.06), transparent 60%),
        linear-gradient(to bottom, rgba(255,255,255,0.06), rgba(0,0,0,0.0));
      transition: opacity 140ms ease;
      pointer-events:none;
      z-index:2;
    }
    .placeholderInner{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      backdrop-filter: blur(10px);
    }
    .phDot{
      width:10px; height:10px;
      border-radius:999px;
      background: rgba(255,255,255,0.72);
      animation: phPulse 900ms ease-in-out infinite;
    }
    @keyframes phPulse{
      0%,100%{ transform:scale(0.8); opacity:0.6; }
      50%{ transform:scale(1.1); opacity:1; }
    }
    .phText{ font-size:13px; color: var(--txt); font-weight:700; letter-spacing:0.2px; }

    .reel[data-ready="1"] .placeholder{ opacity:0; }

    /* Overlays */
    .overlayTopFade{
      position:absolute;
      left:0; right:0; top:0;
      height: 40%;
      background: linear-gradient(to bottom, rgba(0,0,0,0.55), rgba(0,0,0,0.0));
      pointer-events:none;
      z-index:3;
    }
    .overlayBottomFade{
      position:absolute;
      left:0; right:0; bottom:0;
      height: 44%;
      background: linear-gradient(to top, rgba(0,0,0,0.62), rgba(0,0,0,0.0));
      pointer-events:none;
      z-index:3;
    }

    /* Right actions */
    .actions{
      position:absolute;
      right: 10px;
      bottom: 110px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      z-index:5;
    }
    .actionBtn{
      width: 52px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      border-radius: 18px;
      padding: 10px 8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 6px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      backdrop-filter: blur(10px);
    }
    .actionBtn:active{ transform: scale(0.985); }
    .actionIcon{ width:22px; height:22px; display:block; }
    .actionLabel{ font-size:11px; font-weight:800; color: var(--txt); }

    /* Caption (links unten) */
    .caption{
      position:absolute;
      left: 12px;
      bottom: 98px;
      z-index:5;
      max-width: 70%;
    }
    .capUser{
      font-size:14px;
      font-weight:900;
      letter-spacing:0.2px;
      color: var(--txt);
      margin-bottom:6px;
    }
    .capText{
      font-size:13px;
      line-height:1.35;
      color: rgba(255,255,255,0.82);
    }

    /* Product card unten */
    .productCard{
      position:absolute;
      left: 12px;
      bottom: 18px;
      right: 76px; /* Platz fÃ¼r Actions */
      z-index:6;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.30);
      backdrop-filter: blur(12px);
      padding: 10px;
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .productImg{
      width: 54px;
      height: 54px;
      border-radius: 14px;
      object-fit: cover;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      flex: 0 0 auto;
    }
    .productMeta{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 3px;
      flex:1;
    }
    .productName{
      font-size:13px;
      font-weight:900;
      color: var(--txt);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .productSub{
      font-size:12px;
      color: var(--sub);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .productBtn{
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.92);
      height: 38px;
      padding: 0 12px;
      border-radius: 14px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .productBtn:active{ transform: scale(0.985); }

    /* Comments sheet (Demo) */
    .sheet{
      position:fixed;
      left:0; right:0;
      bottom:0;
      height: min(70dvh, 520px);
      background: rgba(10,10,10,0.92);
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      border: 1px solid rgba(255,255,255,0.10);
      transform: translateY(110%);
      transition: transform 220ms ease;
      z-index:50;
      padding-bottom: var(--safe-bot);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      backdrop-filter: blur(14px);
    }
    .sheet.open{ transform: translateY(0); }
    .sheetTop{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .sheetTitle{
      font-size:13px;
      font-weight:900;
      color: var(--txt);
      letter-spacing:0.2px;
    }
    .sheetList{
      padding: 10px 12px;
      overflow:auto;
      flex:1;
    }
    .cItem{
      padding: 10px 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      margin-bottom: 10px;
    }
    .cUser{ font-size:12px; font-weight:900; color: var(--txt); margin-bottom:4px; }
    .cText{ font-size:12px; color: rgba(255,255,255,0.78); line-height:1.35; }
    .sheetInput{
      padding: 10px 12px 12px;
      border-top: 1px solid rgba(255,255,255,0.08);
      display:flex;
      gap:10px;
      align-items:center;
      background: rgba(0,0,0,0.20);
    }
    .sheetInput input{
      flex:1;
      height: 42px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      padding: 0 12px;
      outline:none;
      font-size:13px;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .placeholder, .sheet{ transition:none !important; }
      .phDot{ animation:none !important; }
    }
  </style>
</head>

<body>
  <div class="app" id="app">
    <header class="topbar" aria-label="Story Topbar">
      <button class="iconBtn" id="backBtn" type="button" aria-label="ZurÃ¼ck">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="rgba(255,255,255,0.92)" d="M15.5 19.5 8 12l7.5-7.5 1.8 1.8L11.6 12l5.7 5.7-1.8 1.8z"/>
        </svg>
      </button>

      <img class="logo" src="./images/Prince-coffe-house-logo.jpg" alt="Logo" />
      <div class="titleWrap">
        <div class="title">Prince Coffe House</div>
        <div class="subtitle">Story</div>
      </div>

      <div class="spacer"></div>

      <button class="iconBtn" id="soundBtn" type="button" aria-label="Ton umschalten" title="Sound">
        <svg id="soundIcon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <!-- default = muted icon -->
          <path fill="rgba(255,255,255,0.92)" d="M16.5 12a4.5 4.5 0 0 0-2.02-3.76v7.52A4.5 4.5 0 0 0 16.5 12ZM5 9v6h4l5 4V5L9 9H5Z"/>
          <path fill="rgba(255,255,255,0.62)" d="M19 8.6 17.6 10 20 12.4 17.6 14.8 19 16.2 22.8 12.4 19 8.6Z"/>
        </svg>
      </button>
    </header>

    <main class="feed" id="feed" aria-label="Story Feed">
      <!-- REEL 1 -->
      <section class="reel" data-index="0" data-ready="0">
        <div class="placeholder" aria-hidden="true">
          <div class="placeholderInner">
            <span class="phDot"></span>
            <span class="phText">Loadingâ€¦</span>
          </div>
        </div>

        <div class="overlayTopFade" aria-hidden="true"></div>
        <div class="overlayBottomFade" aria-hidden="true"></div>

        <video
          class="v"
          playsinline
          webkit-playsinline
          preload="auto"
          muted
          loop
          src="./images/tik1.mp4"
        ></video>

        <div class="actions">
          <button class="actionBtn" type="button" data-action="like">
            <svg class="actionIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="rgba(255,255,255,0.92)" d="M12 21s-7-4.6-9.5-9C.7 8.2 3 5 6.4 5c1.9 0 3.2 1 3.6 1.6.4-.6 1.7-1.6 3.6-1.6C17 5 19.3 8.2 21.5 12 19 16.4 12 21 12 21z"/>
            </svg>
            <div class="actionLabel" data-like-count="128">128</div>
          </button>

          <button class="actionBtn" type="button" data-action="comment">
            <svg class="actionIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="rgba(255,255,255,0.92)" d="M4 4h16v11H7.2L4 18.2V4z"/>
            </svg>
            <div class="actionLabel">12</div>
          </button>

          <button class="actionBtn" type="button" data-action="share">
            <svg class="actionIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="rgba(255,255,255,0.92)" d="M14 9V5l7 7-7 7v-4H9c-3 0-5 1-7 3 1-5 4-10 7-11h5z"/>
            </svg>
            <div class="actionLabel">Share</div>
          </button>
        </div>

        <div class="caption">
          <div class="capUser">@princecoffeehouse</div>
          <div class="capText">New drop ðŸ”¥ Burger + Fries today.</div>
        </div>

        <div class="productCard">
          <img class="productImg" src="./images/Prince-coffe-house-offer.jpg" alt="Produkt" />
          <div class="productMeta">
            <div class="productName">Burger + Fries</div>
            <div class="productSub">5.90 â‚¬ â€¢ Marked Product</div>
          </div>
          <button class="productBtn" type="button">Shiko</button>
        </div>
      </section>

      <!-- REEL 2 -->
      <section class="reel" data-index="1" data-ready="0">
        <div class="placeholder" aria-hidden="true">
          <div class="placeholderInner">
            <span class="phDot"></span>
            <span class="phText">Loadingâ€¦</span>
          </div>
        </div>

        <div class="overlayTopFade" aria-hidden="true"></div>
        <div class="overlayBottomFade" aria-hidden="true"></div>

        <video class="v" playsinline webkit-playsinline preload="auto" muted loop src="./images/tik2.mp4"></video>

        <div class="actions">
          <button class="actionBtn" type="button" data-action="like">
            <svg class="actionIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="rgba(255,255,255,0.92)" d="M12 21s-7-4.6-9.5-9C.7 8.2 3 5 6.4 5c1.9 0 3.2 1 3.6 1.6.4-.6 1.7-1.6 3.6-1.6C17 5 19.3 8.2 21.5 12 19 16.4 12 21 12 21z"/>
            </svg>
            <div class="actionLabel" data-like-count="86">86</div>
          </button>

          <button class="actionBtn" type="button" data-action="comment">
            <svg class="actionIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="rgba(255,255,255,0.92)" d="M4 4h16v11H7.2L4 18.2V4z"/>
            </svg>
            <div class="actionLabel">8</div>
          </button>

          <button class="actionBtn" type="button" data-action="share">
            <svg class="actionIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="rgba(255,255,255,0.92)" d="M14 9V5l7 7-7 7v-4H9c-3 0-5 1-7 3 1-5 4-10 7-11h5z"/>
            </svg>
            <div class="actionLabel">Share</div>
          </button>
        </div>

        <div class="caption">
          <div class="capUser">@princecoffeehouse</div>
          <div class="capText">Coffee vibes â˜• smooth & strong.</div>
        </div>

        <div class="productCard">
          <img class="productImg" src="./images/Prince-coffe-house-offer.jpg" alt="Produkt" />
          <div class="productMeta">
            <div class="productName">Cappuccino</div>
            <div class="productSub">2.90 â‚¬ â€¢ Marked Product</div>
          </div>
          <button class="productBtn" type="button">Shiko</button>
        </div>
      </section>

      <!-- REEL 3 -->
      <section class="reel" data-index="2" data-ready="0">
        <div class="placeholder" aria-hidden="true">
          <div class="placeholderInner">
            <span class="phDot"></span>
            <span class="phText">Loadingâ€¦</span>
          </div>
        </div>

        <div class="overlayTopFade" aria-hidden="true"></div>
        <div class="overlayBottomFade" aria-hidden="true"></div>

        <video class="v" playsinline webkit-playsinline preload="auto" muted loop src="./images/tik3.mp4"></video>

        <div class="actions">
          <button class="actionBtn" type="button" data-action="like">
            <svg class="actionIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="rgba(255,255,255,0.92)" d="M12 21s-7-4.6-9.5-9C.7 8.2 3 5 6.4 5c1.9 0 3.2 1 3.6 1.6.4-.6 1.7-1.6 3.6-1.6C17 5 19.3 8.2 21.5 12 19 16.4 12 21 12 21z"/>
            </svg>
            <div class="actionLabel" data-like-count="203">203</div>
          </button>

          <button class="actionBtn" type="button" data-action="comment">
            <svg class="actionIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="rgba(255,255,255,0.92)" d="M4 4h16v11H7.2L4 18.2V4z"/>
            </svg>
            <div class="actionLabel">21</div>
          </button>

          <button class="actionBtn" type="button" data-action="share">
            <svg class="actionIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="rgba(255,255,255,0.92)" d="M14 9V5l7 7-7 7v-4H9c-3 0-5 1-7 3 1-5 4-10 7-11h5z"/>
            </svg>
            <div class="actionLabel">Share</div>
          </button>
        </div>

        <div class="caption">
          <div class="capUser">@princecoffeehouse</div>
          <div class="capText">Quick bite, big taste âœ…</div>
        </div>

        <div class="productCard">
          <img class="productImg" src="./images/Prince-coffe-house-offer.jpg" alt="Produkt" />
          <div class="productMeta">
            <div class="productName">Burger Menu</div>
            <div class="productSub">5.90 â‚¬ â€¢ Marked Product</div>
          </div>
          <button class="productBtn" type="button">Shiko</button>
        </div>
      </section>
    </main>
  </div>

  <!-- Comments sheet (Demo) -->
  <section class="sheet" id="sheet" aria-hidden="true">
    <div class="sheetTop">
      <div class="sheetTitle">Komentet</div>
      <button class="iconBtn" id="sheetCloseBtn" type="button" aria-label="Close">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="rgba(255,255,255,0.92)" d="M18.3 5.7 12 12l6.3 6.3-1.3 1.3L10.7 13.3 4.4 19.6 3.1 18.3 9.4 12 3.1 5.7 4.4 4.4l6.3 6.3L17 4.4l1.3 1.3z"/>
        </svg>
      </button>
    </div>
    <div class="sheetList" id="sheetList">
      <div class="cItem"><div class="cUser">Ardi</div><div class="cText">ðŸ”¥ðŸ”¥ super</div></div>
      <div class="cItem"><div class="cUser">Lina</div><div class="cText">Kur ka edhe sot?</div></div>
      <div class="cItem"><div class="cUser">Denis</div><div class="cText">Perfect vibe</div></div>
    </div>
    <div class="sheetInput">
      <input type="text" placeholder="Shkruaj komentâ€¦" />
      <button class="productBtn" type="button">Send</button>
    </div>
  </section>

  <script type="module">
    // =========================================================
    // MENYRA STORY (TikTok-like) â€” schlank, schnell, iOS-safe
    // =========================================================

    const feed = document.getElementById("feed");
    const backBtn = document.getElementById("backBtn");
    const soundBtn = document.getElementById("soundBtn");
    const soundIcon = document.getElementById("soundIcon");

    const sheet = document.getElementById("sheet");
    const sheetCloseBtn = document.getElementById("sheetCloseBtn");

    const reels = Array.from(document.querySelectorAll(".reel"));
    const videos = reels.map(r => r.querySelector("video.v"));

    let activeIndex = 0;
    let soundOn = false; // default: muted (TikTok-like)
    const SOUND_KEY = "menyra_story_sound";

    // ---------- App height (Safe browser UI) ----------
    function setAppHeight(){
      const vv = window.visualViewport;
      const h = vv ? vv.height : window.innerHeight;
      document.documentElement.style.setProperty("--app-h", h + "px");
    }
    setAppHeight();
    window.addEventListener("resize", setAppHeight, { passive: true });
    if (window.visualViewport){
      window.visualViewport.addEventListener("resize", setAppHeight, { passive: true });
      window.visualViewport.addEventListener("scroll", setAppHeight, { passive: true });
    }

    // ---------- Back behavior ----------
    backBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      // fix: immer korrekt zurÃ¼ck zur Demo
      window.location.href = "./karte-demo.html";
    }, { passive: false });

    // ---------- Sheet (Kommentare) ----------
    function openSheet(){
      sheet.classList.add("open");
      sheet.setAttribute("aria-hidden", "false");
    }
    function closeSheet(){
      sheet.classList.remove("open");
      sheet.setAttribute("aria-hidden", "true");
    }
    sheetCloseBtn?.addEventListener("click", closeSheet, { passive: true });

    // ---------- Sound ----------
    function renderSoundIcon(){
      // muted icon vs sound icon
      if (!soundIcon) return;
      if (!soundOn){
        soundIcon.innerHTML = `
          <path fill="rgba(255,255,255,0.92)" d="M16.5 12a4.5 4.5 0 0 0-2.02-3.76v7.52A4.5 4.5 0 0 0 16.5 12ZM5 9v6h4l5 4V5L9 9H5Z"/>
          <path fill="rgba(255,255,255,0.62)" d="M19 8.6 17.6 10 20 12.4 17.6 14.8 19 16.2 22.8 12.4 19 8.6Z"/>
        `;
      } else {
        soundIcon.innerHTML = `
          <path fill="rgba(255,255,255,0.92)" d="M5 9v6h4l5 4V5L9 9H5Z"/>
          <path fill="rgba(255,255,255,0.92)" d="M16.5 7.5a7 7 0 0 1 0 9.9l-1.4-1.4a5 5 0 0 0 0-7.1l1.4-1.4z"/>
          <path fill="rgba(255,255,255,0.72)" d="M18.9 5.1a10 10 0 0 1 0 13.8l-1.4-1.4a8 8 0 0 0 0-11l1.4-1.4z"/>
        `;
      }
    }

    soundOn = (localStorage.getItem(SOUND_KEY) === "1");
    renderSoundIcon();

    soundBtn?.addEventListener("click", async (e) => {
      e.preventDefault();
      soundOn = !soundOn;
      localStorage.setItem(SOUND_KEY, soundOn ? "1" : "0");
      renderSoundIcon();
      // apply immediately to active video
      await applyActivePlayback(true);
    }, { passive: false });

    // ---------- Ready (first frame rendered) ----------
    function markReady(index){
      const reel = reels[index];
      if (!reel) return;
      if (reel.dataset.ready === "1") return;
      reel.dataset.ready = "1";
    }

    function hookFirstFrame(index){
      const v = videos[index];
      if (!v) return;

      // When first real frame is painted -> placeholder away
      // requestVideoFrameCallback is best (no poster mismatch)
      const hasRVFC = typeof v.requestVideoFrameCallback === "function";

      const onFirstFrame = () => markReady(index);

      // ensure we only mark once
      let done = false;
      const once = () => {
        if (done) return;
        done = true;
        onFirstFrame();
      };

      if (hasRVFC){
        // We call it once; if video is paused, it may wait until play.
        try{
          v.requestVideoFrameCallback(() => once());
        } catch {}
      }

      // Fallback
      v.addEventListener("playing", () => once(), { once: true });
      v.addEventListener("loadeddata", () => {
        // loadeddata = first frame available (may still not be painted everywhere)
        // but good fallback to avoid black
        once();
      }, { once: true });
    }

    // ---------- Preload / prime ----------
    videos.forEach((v, i) => {
      if (!v) return;
      v.muted = true;
      v.loop = true;
      v.preload = "auto";
      v.playsInline = true;
      v.setAttribute("playsinline", "");
      v.setAttribute("webkit-playsinline", "");

      hookFirstFrame(i);

      // Start loading now
      try { v.load(); } catch {}
    });

    // ---------- Playback control ----------
    async function applyActivePlayback(isUserGesture = false){
      const reelH = feed.clientHeight || 1;
      // make sure activeIndex matches scroll position (safety)
      const idx = Math.max(0, Math.min(reels.length - 1, Math.round(feed.scrollTop / reelH)));
      activeIndex = idx;

      // pause all non-active always (fix: no audio without video)
      for (let i = 0; i < videos.length; i++){
        const v = videos[i];
        if (!v) continue;
        if (i !== activeIndex){
          try { v.pause(); } catch {}
          v.muted = true;
        }
      }

      const v = videos[activeIndex];
      if (!v) return;

      // if already has data, ensure placeholder is gone (fix: revisit + invisible)
      if (v.readyState >= 2) markReady(activeIndex);

      // Sound behavior:
      // - default muted autoplay works everywhere
      // - soundOn tries to unmute active (may be blocked; we fallback to muted)
      v.muted = !soundOn;

      try{
        const p = v.play();
        if (p && typeof p.then === "function"){
          await p;
        }
      } catch (err){
        // If unmuted autoplay blocked, fallback to muted but keep UI state (minimal)
        if (soundOn && !isUserGesture){
          v.muted = true;
          try{ await v.play(); } catch {}
        }
      }
    }

    // ---------- Perfect snap (fix "last mm slow") ----------
    let snapTimer = 0;
    function snapToNearest(){
      const reelH = feed.clientHeight || 1;
      const idx = Math.max(0, Math.min(reels.length - 1, Math.round(feed.scrollTop / reelH)));
      const target = idx * reelH;
      const diff = Math.abs(feed.scrollTop - target);

      // only correct if small drift exists (prevents jitter)
      if (diff > 2){
        feed.scrollTo({ top: target, behavior: "auto" });
      }
    }

    feed.addEventListener("scroll", () => {
      // passive: smooth
      window.clearTimeout(snapTimer);
      snapTimer = window.setTimeout(() => {
        snapToNearest();
        applyActivePlayback(false);
      }, 80);
    }, { passive: true });

    // ---------- IntersectionObserver (fast) ----------
    const io = new IntersectionObserver((entries) => {
      let best = null;
      for (const e of entries){
        if (!e.isIntersecting) continue;
        if (!best || e.intersectionRatio > best.intersectionRatio) best = e;
      }
      if (!best) return;

      const idx = Number(best.target.dataset.index || "0") || 0;
      if (idx !== activeIndex){
        activeIndex = idx;
        applyActivePlayback(false);
      }
    }, { root: feed, threshold: [0.60, 0.75, 0.90] });

    reels.forEach(r => io.observe(r));

    // ---------- Actions (like/comment) ----------
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      if (action === "comment"){
        openSheet();
        return;
      }
      if (action === "like"){
        const label = btn.querySelector("[data-like-count]");
        if (label){
          const cur = parseInt(label.textContent.trim(), 10) || 0;
          // toggle feel (demo)
          const liked = btn.classList.toggle("is-liked");
          label.textContent = String(liked ? cur + 1 : Math.max(0, cur - 1));
        }
        return;
      }
    }, { passive: true });

    // close sheet on outside tap
    document.addEventListener("click", (e) => {
      if (!sheet.classList.contains("open")) return;
      const inside = sheet.contains(e.target);
      if (!inside) closeSheet();
    }, { passive: true });

    // ---------- Visibility (fix iOS background issues) ----------
    document.addEventListener("visibilitychange", () => {
      if (document.hidden){
        videos.forEach(v => { try{ v.pause(); } catch{} });
      } else {
        applyActivePlayback(false);
      }
    }, { passive: true });

    // ---------- Start: snap to top + autoplay first ----------
    // (muted autoplay should work; placeholder hides black frames)
    window.requestAnimationFrame(() => {
      feed.scrollTo({ top: 0, behavior: "auto" });
      applyActivePlayback(false);
    });
  </script>
</body>
</html>
